<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
   
    <link rel="stylesheet" href="style_dhl.css">
    
    <title>üì¶ Gestor de Pedidos</title>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üì¶ Gestor de pedidos</h1>
            <div class="header-buttons-container">
                <button class="btn" onclick="abrirModalCrearPedido()">
                    + Crear pedido
                </button>
            </div>
        </div>

        <!-- Panel de pedidos -->
        
            <div class="panel-header">
                    <button class="btn" onclick="abrirInputCargarPedidos('pedidos')">
                        üì§ Cargar Pedidos
                    </button>
                    <button class="btn" onclick="descargarPedidos()">
                        üì• Descargar todos
                    </button>
                
            </div>
            
            <div id="pedidos-container">
                <!-- Aqu√≠ se mostrar√°n los pedidos din√°micamente -->
            </div>

            <!-- Estado vac√≠o pedidos -->
            <div id="empty-state-pedidos">
            </div>
        
    </div>

    <!-- Botones flotantes laterales -->
    
    <button class="dhl-floating-button" onclick="abrirModalSeguimiento()">
        DHL
    </button>

    



    <!-- Inputs ocultos para cargar archivos -->
    <input type="file" id="input-cargar-pedidos" accept=".json" multiple
           class="hidden-input" onchange="cargarPedidos(this, 'pedidos')">

    <!-- Modal para crear pedido -->
    <div id="modal-crear-pedido" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Crear Nuevo Pedido</h2>
                <span class="close" onclick="cerrarModal()">&times;</span>
            </div>
            
            <form id="form-crear-pedido">
                <div class="form-group">
                    <label for="numero_oferta">N√∫mero de Oferta</label>
                    <input type="text" id="numero_oferta" name="numero_oferta">
                </div>

                <div class="form-group">
                    <label for="proveedor">Proveedor</label>
                    <input type="text" id="proveedor" name="proveedor">
                </div>

                <div class="form-group">
                    <label for="email_proveedor">Email Proveedor</label>
                    <input type="text" id="email_proveedor" name="email_proveedor">
                </div>

                <div class="form-group">
                    <label for="fecha_oferta">Fecha de la Oferta</label>
                    <input type="date" id="fecha_oferta" name="fecha_oferta">
                </div>

                <div class="form-group">
                    <label for="oferta_pdf">PDF de la Oferta</label>
                    <input type="file" id="oferta_pdf" name="oferta_pdf" accept=".pdf">
                </div>

                <div class="pieces-container">
                    <h3 class="pieces-title">Piezas del Pedido</h3>
                    <div id="pieces-grid">
                        <div class="piece-row pieces-header-row">
                            <div class="pieces-header-cell">Referencia</div>
                            <div class="pieces-header-cell">Descripci√≥n</div>
                            <div class="pieces-header-cell">Proyecto</div>
                            <div class="pieces-header-cell">Cantidad</div>
                            <div class="pieces-header-cell">Precio Unit. (‚Ç¨)</div>
                            <div class="pieces-header-cell">Total Fila (‚Ç¨)</div>
                            <div class="pieces-header-cell">  </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary add-piece-btn" onclick="agregarPieza()">+ Agregar Pieza</button>
                    <div class="total-row">
                        Total: ‚Ç¨<span id="total-pedido">0.000</span>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
                    <button type="submit" class="btn">Crear Pedido</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para lanzar Eproc -->
    <div id="modal-lanzar-eproc" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Lanzar Eproc</h2>
                <span class="close" onclick="cerrarModalLanzarEproc()">&times;</span>
            </div>
            
            <form id="form-lanzar-eproc">
                <input type="hidden" id="lanzar-eproc-pedido-id">
                
                <div class="form-group">
                    <label for="lanzar_eproc_numero">N√∫mero Eproc</label>
                    <input type="text" id="lanzar_eproc_numero" name="numero">
                </div>

                <div class="form-group">
                    <label for="lanzar_eproc_oi">OI</label>
                    <input type="text" id="lanzar_eproc_oi" name="oi">
                </div>

                <div class="form-group">
                    <label for="lanzar_eproc_short_description">Short Description</label>
                    <div class="input-row-sd">
                        <textarea id="lanzar_eproc_short_description" name="short_description" rows="3" class="sd-textarea" placeholder="Ingrese la descripci√≥n corta del EPROC"></textarea>
                        
                    </div>
                </div>

                <div class="form-group">
                    <label for="lanzar_eproc_fecha">Fecha</label>
                    <input type="date" id="lanzar_eproc_fecha" name="fecha">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalLanzarEproc()">Cancelar</button>
                    <button type="submit" class="btn">Lanzar Eproc</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para firmar Eproc -->
    <div id="modal-firmar-eproc" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Firmar Eproc</h2>
                <span class="close" onclick="cerrarModalFirmarEproc()">&times;</span>
            </div>
            
            <form id="form-firmar-eproc">
                <input type="hidden" id="firmar-eproc-pedido-id">
                
                <div class="form-group">
                    <label for="firmar_eproc_pdf">PDF de la PO</label>
                    <input type="file" id="firmar_eproc_pdf" name="pdf" accept=".pdf">
                </div>

                <div class="form-group">
                    <label for="firmar_eproc_po">N√∫mero PO</label>
                    <input type="text" id="firmar_eproc_po" name="po">
                </div>

                <div class="form-group">
                    <label for="firmar_eproc_fecha">Fecha</label>
                    <input type="date" id="firmar_eproc_fecha" name="fecha">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalFirmarEproc()">Cancelar</button>
                    <button type="submit" class="btn">Firmar Eproc</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para crear Packing List -->
    <div id="modal-packing-list" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Crear Packing List</h2>
                <span class="close" onclick="cerrarModalPackingList()">&times;</span>
            </div>
            
            <form id="form-packing-list">
                <input type="hidden" id="packing-list-pedido-id">
                
                <div class="form-group">
                    <label for="packing_list_pdf">PDF del Packing List</label>
                    <input type="file" id="packing_list_pdf" name="pdf" accept=".pdf">
                </div>

                <div class="form-group">
                    <label for="packing_list_bultos">N√∫mero de bultos</label>
                    <input type="number" id="packing_list_bultos" name="bultos" min="1" onchange="generarConfiguracionBultos()">
                </div>

                <div class="form-group">
                    <label for="packing_list_fecha">Fecha</label>
                    <input type="date" id="packing_list_fecha" name="fecha">
                </div>

                <div class="form-group">
                    <label for="packing_list_peso_total">Peso Total (kg)</label>
                    <input type="number" id="packing_list_peso_total" name="peso_total" step="0.1" min="0" placeholder="0.0">
                </div>

                <!-- Configuraci√≥n de bultos -->
                <div id="configuracion-bultos-container" style="margin-top: 20px; display: none;">
                    <h3 style="color: #374151; margin-bottom: 15px;">Configuraci√≥n de Bultos</h3>
                    <p style="color: #6b7280; margin-bottom: 15px;">Asigne las piezas a cada bulto:</p>
                    
                    <div style="display: flex; gap: 20px; align-items: flex-start;">
                        <!-- Lista de piezas disponibles -->
                        <div style="flex: 1; min-width: 250px;">
                            <h4 style="margin-bottom: 10px; color: #374151;">Piezas Disponibles</h4>
                            <div id="piezas-disponibles" style="
                                border: 2px solid #d1d5db; 
                                border-radius: 8px; 
                                padding: 15px; 
                                background: #f9fafb;
                                min-height: 300px;
                                max-height: 400px;
                                overflow-y: auto;
                            ">
                                <!-- Se llenar√° din√°micamente -->
                            </div>
                        </div>
                        
                        <!-- Botones de control -->
                        <div style="display: flex; flex-direction: column; gap: 10px; padding-top: 40px;">
                            <button type="button" onclick="moverPiezaABulto()" style="
                                padding: 10px 15px;
                                border: 2px solid #374151;
                                background: #374151;
                                color: white;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                            ">‚Üí</button>
                            <button type="button" onclick="regresarPiezaADisponibles()" style="
                                padding: 10px 15px;
                                border: 2px solid #374151;
                                background: white;
                                color: #374151;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                            ">‚Üê</button>
                        </div>
                        
                        <!-- Bultos -->
                        <div style="flex: 2; min-width: 300px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <h4 style="margin: 0; color: #374151;">Bultos</h4>
                                <select id="bulto-selector" style="
                                    padding: 5px 10px;
                                    border: 2px solid #d1d5db;
                                    border-radius: 6px;
                                    background: white;
                                ">
                                    <!-- Se llenar√° din√°micamente -->
                                </select>
                            </div>
                            
                            <!-- Informaci√≥n del bulto seleccionado -->
                            <div id="info-bulto-container" style="margin-bottom: 15px; display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; background: #f3f4f6; border-radius: 6px; margin-bottom: 10px;">
                                    <div>
                                        <label style="font-size: 12px; color: #6b7280; display: block;">Peso (kg)</label>
                                        <input type="number" id="bulto-peso" step="0.1" min="0" placeholder="0.0" style="
                                            width: 100%; 
                                            padding: 5px; 
                                            border: 1px solid #d1d5db; 
                                            border-radius: 4px;
                                            font-size: 14px;
                                        " onchange="actualizarInfoBulto()">
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: #6b7280; display: block;">Dimensiones (cm)</label>
                                        <input type="text" id="bulto-dimensiones" placeholder="L x W x H" style="
                                            width: 100%; 
                                            padding: 5px; 
                                            border: 1px solid #d1d5db; 
                                            border-radius: 4px;
                                            font-size: 14px;
                                        " onchange="actualizarInfoBulto()">
                                    </div>
                                </div>
                            </div>
                            
                            <div id="bulto-contenido" style="
                                border: 2px solid #d1d5db; 
                                border-radius: 8px; 
                                padding: 15px; 
                                background: white;
                                min-height: 300px;
                                max-height: 400px;
                                overflow-y: auto;
                            ">
                                <p style="color: #9ca3af; text-align: center; margin-top: 50px;">
                                    Seleccione un bulto y use los botones para asignar piezas
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalPackingList()">Cancelar</button>
                    <button type="submit" class="btn">Crear Packing List</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para lanzar TAR -->
    <div id="modal-lanzar-tar" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Lanzar TAR</h2>
                <span class="close" onclick="cerrarModalLanzarTar()">&times;</span>
            </div>
            
            <form id="form-lanzar-tar">
                <input type="hidden" id="lanzar-tar-pedido-id">
                
                <div class="form-group">
                    <label for="lanzar_tar_numero">N√∫mero TAR</label>
                    <input type="text" id="lanzar_tar_numero" name="numero">
                </div>

                <div class="form-group">
                    <label for="lanzar_tar_email">Email Log√≠stica</label>
                    <input type="text" id="lanzar_tar_email" name="email">
                </div>

                <div class="form-group">
                    <label for="lanzar_tar_url">URL</label>
                    <input type="url" id="lanzar_tar_url" name="url">
                </div>

                <div class="form-group">
                    <label for="lanzar_tar_fecha">Fecha</label>
                    <input type="date" id="lanzar_tar_fecha" name="fecha">
                </div>

                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalLanzarTar()">Cancelar</button>
                    <button type="submit" class="btn">Lanzar TAR</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para enviar etiquetas -->
    <div id="modal-enviar-etiquetas" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Enviar Etiquetas</h2>
                <span class="close" onclick="cerrarModalEnviarEtiquetas()">&times;</span>
            </div>
            
            <form id="form-enviar-etiquetas">
                <input type="hidden" id="enviar-etiquetas-pedido-id">
                
                <div class="form-group">
                    <label for="enviar_etiquetas_pdf">PDF de las etiquetas</label>
                    <input type="file" id="enviar_etiquetas_pdf" name="pdf" accept=".pdf">
                </div>

                <div class="form-group">
                    <label for="enviar_etiquetas_tracking">N√∫mero de tracking</label>
                    <input type="text" id="enviar_etiquetas_tracking" name="tracking">
                </div>

                <div class="form-group">
                    <label for="enviar_etiquetas_direccion_envio">Direcci√≥n de recogida</label>
                    <textarea id="enviar_etiquetas_direccion_envio" name="direccion_envio" rows="3" placeholder="Direcci√≥n completa desde donde recoger el paquete"></textarea>
                </div>

                <div class="form-group">
                    <label for="enviar_etiquetas_fecha">Fecha</label>
                    <input type="date" id="enviar_etiquetas_fecha" name="fecha">
                </div>

                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalEnviarEtiquetas()">Cancelar</button>
                    <button type="submit" class="btn">Enviar Etiquetas</button>
                    <button type="button" class="btn" onclick="abrirGmailEtiquetas()" style="background-color: #34A853; border-color: #34A853;">Enviar Gmail</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para ver detalles completos -->
    <div id="modal-detalle-completo" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <h2 id="detalle-titulo">Detalles del Pedido</h2>
                <span class="close" onclick="cerrarModalDetalle()">&times;</span>
            </div>
            
            <div id="detalle-contenido" style="max-height: 70vh; overflow-y: auto;">
                <!-- Se llenar√° din√°micamente -->
            </div>

            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="cerrarModalDetalle()">Cerrar</button>
            </div>
        </div>
    </div>



   <!-- Modal para Seguimiento DHL -->
    <div id="modal-seguimiento-dhl" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <h2>üöö Seguimiento DHL API</h2>
                <span class="close" onclick="cerrarModalSeguimiento()">&times;</span>
            </div>
            
            <div style="max-height: 70vh; overflow-y: auto; padding: 20px;">
                <!-- Panel para guardar entradas DHL -->
                <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #0ea5e9;">
                    <h3 style="color: #0c4a6e; margin-bottom: 15px;">üíæ Guardar Entrada DHL</h3>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label for="entrada-tracking" style="display: block; margin-bottom: 5px; font-weight: 500; color: #0c4a6e;">
                                Tracking Number
                            </label>
                            <input type="text" id="entrada-tracking" placeholder="Ej: 1234567890" 
                                   style="width: 100%; padding: 10px; border: 1px solid #0ea5e9; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div>
                            <label for="entrada-asunto" style="display: block; margin-bottom: 5px; font-weight: 500; color: #0c4a6e;">
                                Asunto
                            </label>
                            <input type="text" id="entrada-asunto" placeholder="Ej: Pedido #123 - Cliente ABC" 
                                   style="width: 100%; padding: 10px; border: 1px solid #0ea5e9; border-radius: 6px; font-size: 14px;">
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="guardarEntradaDHL()" class="btn" 
                                style="background: #0ea5e9; border-color: #0ea5e9; padding: 8px 16px;">
                            üíæ Guardar Entrada
                        </button>
                    </div>
                </div>

                <!-- Lista de entradas guardadas -->
                <div id="entradas-dhl-container" style="background: #fefefe; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e5e7eb;">
                    <h3 style="color: #374151; margin-bottom: 15px;">üìã Entradas Guardadas</h3>
                    <div id="lista-entradas-dhl">
                        <!-- Aqu√≠ se mostrar√°n las entradas guardadas -->
                    </div>
                </div>

                <!-- Secci√≥n de entrada de tracking -->
                <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    
                    <div style="display: flex; gap: 15px; align-items: end;">
                        <div style="flex: 1;">
                            <label for="tracking-input" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">
                                N√∫mero de Tracking DHL
                            </label>
                            <input type="text" id="tracking-input" placeholder="Ej: 1234567890 o JD001234567890" 
                                   style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                        </div>
                        <button onclick="consultarAPIDHL()" class="btn" 
                                style="background: #ff6b00; border-color: #ff6b00; padding: 10px 20px;">
                            üîç Consultar API
                        </button>
                    </div>
                    
                </div>

                <!-- Contenedor para mostrar resultados -->
                <div id="dhl-frame-container" style="display: none;">
                    <!-- Aqu√≠ se mostrar√°n los resultados de la API -->
                </div>

                <!-- Mensaje de instrucciones inicial -->
                <div id="instrucciones-iniciales" style="text-align: center; padding: 60px 20px;">


                </div>
            </div>

            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 20px; padding: 20px; border-top: 1px solid #e5e7eb;">
                <button type="button" class="btn btn-secondary" onclick="cerrarModalSeguimiento()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal para a√±adir nota -->
    <div id="modal-nota" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>A√±adir Nota</h2>
                <span class="close" onclick="cerrarModalNota()">&times;</span>
            </div>
            
            <form id="form-nota">
                <div class="form-group">
                    <label for="texto-nota">Nota</label>
                    <textarea id="texto-nota" name="texto-nota" rows="4"     
                              style="width: 100%; min-height: 100px; resize: vertical;"></textarea>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalNota()">Cancelar</button>
                    <button type="button" class="btn" onclick="guardarNota()" style="background: #3b82f6; color: white; border-color: #3b82f6;">Guardar Nota</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Datos en memoria
        let pedidos = JSON.parse(localStorage.getItem('pedidos')) || [];
        let nextId = parseInt(localStorage.getItem('nextId')) || 1;

        // Estados del workflow (9 estados sin bultos)
        const ESTADOS = [
            'oferta_recibida', 
            'eproc_lanzado', 
            'eproc_firmado', 
            'packing_list_creado', 
            'tar_lanzado', 
            'etiquetas_enviadas', 
            'recibido_planta', 
            'sin_incidencias', 
            'completado'
        ];
        const NOMBRES_ESTADOS = {
            'oferta_recibida': 'Oferta<br>Recibida',
            'eproc_lanzado': 'Eproc<br>Lanzado',
            'eproc_firmado': 'Eproc<br>Firmado',
            'packing_list_creado': 'Packing<br>List',
            'tar_lanzado': 'TAR<br>Lanzado',
            'etiquetas_enviadas': 'Etiquetas<br>Enviadas',
            'recibido_planta': 'Paquete<br>Recogido',
            'sin_incidencias': 'Paquete<br>en Casa',
            'completado': 'Paquete<br>Recogido'
        };

        // Funci√≥n para obtener nombres de estados sin HTML
        function getNombreEstadoTexto(estado) {
            const nombres = {
                'oferta_recibida': 'Oferta Recibida',
                'eproc_lanzado': 'Eproc Lanzado', 
                'eproc_firmado': 'Eproc Firmado',
                'packing_list_creado': 'Packing List',
                'tar_lanzado': 'TAR Lanzado',
                'etiquetas_enviadas': 'Etiquetas Enviadas',
                'recibido_planta': 'Paquete Recogido',
                'sin_incidencias': 'Paquete en Casa',
                'completado': 'Paquete Recogido'
            };
            return nombres[estado] || estado;
        }

        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            mostrarPedidos();
            agregarPieza(); // Agregar una pieza inicial
        });

        // Funci√≥n para obtener la fecha de hoy en formato YYYY-MM-DD
        function obtenerFechaHoy() {
            const hoy = new Date();
            return hoy.toISOString().split('T')[0];
        }

        // Guardar datos en localStorage
        function guardarDatos() {
            localStorage.setItem('pedidos', JSON.stringify(pedidos));
            localStorage.setItem('nextId', nextId.toString());
        }

        // ===============================
        // FUNCIONES DE BACKUP/RESTORE
        // ===============================
        
        // Funci√≥n para descargar todos los pedidos como archivo JSON
        function descargarPedidos() {
            try {
                // Crear objeto con todos los datos
                const datosCompletos = {
                    version: "1.0",
                    fechaExportacion: new Date().toISOString(),
                    totalPedidos: pedidos.length,
                    nextId: nextId,
                    pedidos: pedidos
                };

                // Convertir a JSON con formato legible
                const jsonString = JSON.stringify(datosCompletos, null, 2);
                
                // Crear blob y URL para descargar
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Crear enlace temporal para descarga
                const link = document.createElement('a');
                link.href = url;
                
                // Generar nombre de archivo con fecha y hora
                const fecha = new Date();
                const fechaFormateada = fecha.toISOString().slice(0, 19).replace(/:/g, '-');
                link.download = `gestor-pedidos-backup-${fechaFormateada}.json`;
                
                // Ejecutar descarga
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Limpiar URL
                URL.revokeObjectURL(url);
                

                
            } catch (error) {
                console.error('Error al descargar pedidos:', error);
                alert('‚ùå Error al descargar los pedidos. Revisa la consola para m√°s detalles.');
            }
        }

        // Funci√≥n para descargar un pedido individual
        function descargarPedidoIndividual(pedidoId) {
            try {
                // Encontrar el pedido espec√≠fico
                const pedido = pedidos.find(p => p.id === pedidoId);
                
                if (!pedido) {
                    alert('‚ùå Error: No se encontr√≥ el pedido solicitado.');
                    return;
                }

                // Crear objeto con el pedido individual
                const datosCompletos = {
                    version: "1.0",
                    fechaExportacion: new Date().toISOString(),
                    totalPedidos: 1,
                    nextId: nextId,
                    pedidos: [pedido]
                };

                // Convertir a JSON con formato legible
                const jsonString = JSON.stringify(datosCompletos, null, 2);
                
                // Crear blob y URL para descargar
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Crear enlace temporal para descarga
                const link = document.createElement('a');
                link.href = url;
                
                // Generar nombre de archivo espec√≠fico
                const fecha = new Date();
                const fechaFormateada = fecha.toISOString().slice(0, 10);
                const tipo = pedido.tipo === 'TAR' ? 'TAR' : 'Pedido';
                
                // Limpiar el nombre del proveedor para el archivo (sin espacios ni caracteres especiales)
                const proveedorLimpio = pedido.proveedor 
                    ? pedido.proveedor.replace(/[^a-zA-Z0-9]/g, '_').toUpperCase()
                    : 'SIN_PROVEEDOR';
                
                link.download = `${tipo}-${pedido.id}-${proveedorLimpio}-${fechaFormateada}.json`;
                
                // Ejecutar descarga
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Limpiar URL
                URL.revokeObjectURL(url);
                

                
            } catch (error) {
                console.error('Error al descargar pedido individual:', error);
                alert('‚ùå Error al descargar.');
            }
        }

        // Funci√≥n para abrir el input de archivo (carga)
        function abrirInputCargarPedidos(tipo = 'pedidos') {
            if (tipo === 'tar') {
                document.getElementById('input-cargar-tar').click();
            } else {
                document.getElementById('input-cargar-pedidos').click();
            }
        }

        // Funci√≥n para cargar pedidos desde archivo JSON
        function cargarPedidos(inputElement, tipo = 'pedidos') {
            const archivos = Array.from(inputElement.files);
            
            if (archivos.length === 0) {
                return;
            }

            // Verificar que todos sean archivos JSON
            const archivosInvalidos = archivos.filter(archivo => !archivo.name.toLowerCase().endsWith('.json'));
            if (archivosInvalidos.length > 0) {
                alert(`‚ùå Error: Solo se permiten archivos JSON (.json)\n\nArchivos inv√°lidos:\n${archivosInvalidos.map(a => a.name).join('\n')}`);
                inputElement.value = '';
                return;
            }

            const tipoTexto = tipo === 'tar' ? 'TAR' : 'Pedidos';
            
            // Proceder con la carga de archivos
            const totalPedidosActuales = tipo === 'tar' ? 
                pedidos.filter(p => p.tipo === 'TAR').length : 
                pedidos.filter(p => p.tipo !== 'TAR').length;

            // Variables para seguimiento del progreso
            let archivosProcessados = 0;
            let totalPedidosImportados = 0;
            let errores = [];
            let maxIdActual = pedidos.length > 0 ? Math.max(...pedidos.map(p => p.id)) : 0;

            // Funci√≥n para procesar cada archivo
            function procesarArchivo(archivo, index) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const datosImportados = JSON.parse(e.target.result);
                        
                        // Validar estructura del archivo
                        if (!datosImportados.pedidos || !Array.isArray(datosImportados.pedidos)) {
                            throw new Error(`Estructura de archivo inv√°lida: no se encontr√≥ array de pedidos`);
                        }

                        // Filtrar seg√∫n el tipo solicitado
                        let pedidosFiltrados;
                        if (tipo === 'tar') {
                            pedidosFiltrados = datosImportados.pedidos.filter(p => p.tipo === 'TAR');
                        } else {
                            pedidosFiltrados = datosImportados.pedidos.filter(p => p.tipo !== 'TAR');
                        }

                        // Asignar nuevos IDs √∫nicos a los pedidos importados
                        pedidosFiltrados.forEach(pedidoImportado => {
                            maxIdActual++;
                            pedidoImportado.id = maxIdActual;
                            pedidos.push(pedidoImportado);
                        });
                        
                        totalPedidosImportados += pedidosFiltrados.length;
                        
                    } catch (error) {
                        console.error('Error al procesar archivo:', error);
                        errores.push(`${archivo.name}: ${error.message}`);
                    }
                    
                    archivosProcessados++;
                    
                    // Si todos los archivos han sido procesados
                    if (archivosProcessados === archivos.length) {
                        finalizarCarga();
                    }
                };

                reader.onerror = function() {
                    errores.push(`${archivo.name}: Error al leer el archivo`);
                    archivosProcessados++;
                    
                    if (archivosProcessados === archivos.length) {
                        finalizarCarga();
                    }
                };

                // Leer el archivo
                reader.readAsText(archivo);
            }

            function finalizarCarga() {
                // Actualizar nextId para evitar conflictos futuros
                const maxIdFinal = pedidos.length > 0 ? Math.max(...pedidos.map(p => p.id)) : 0;
                nextId = Math.max(nextId, maxIdFinal + 1);

                // Guardar en localStorage
                guardarDatos();
                
                // Actualizar la interfaz
                mostrarPedidos();
                
                // Solo mostrar errores si los hay
                if (errores.length > 0) {
                    alert(`‚ö†Ô∏è ERRORES ENCONTRADOS:\n${errores.join('\n')}`);
                }
                
                // Limpiar el input
                inputElement.value = '';
            }

            // Procesar todos los archivos
            archivos.forEach((archivo, index) => {
                procesarArchivo(archivo, index);
            });
        }

        // Mostrar pedidos
        function mostrarPedidos() {
            const pedidosContainer = document.getElementById('pedidos-container');
            const emptyStatePedidos = document.getElementById('empty-state-pedidos');
            
            // Filtrar solo pedidos (excluir TAR)
            const solosPedidos = pedidos.filter(p => p.tipo !== 'TAR');
            
            // Mostrar pedidos
            if (solosPedidos.length === 0) {
                pedidosContainer.innerHTML = '';
                emptyStatePedidos.style.display = 'block';
            } else {
                emptyStatePedidos.style.display = 'none';
                pedidosContainer.innerHTML = solosPedidos.map(pedido => crearTarjetaPedido(pedido)).join('');
            }
        }

        // Crear tarjeta de pedido
        function crearTarjetaPedido(pedido) {
            const estadoIndex = ESTADOS.indexOf(pedido.estado);
            const esTar = pedido.tipo === 'TAR';
            const claseCompletado = pedido.estado === 'completado' ? ' completado' : '';
            
            return `
                <div class="pedido-card${claseCompletado}" data-pedido-id="${pedido.id}">
                    <div class="pedido-header">
                        <div class="pedido-info">
                            <h3>${esTar ? 'üöö TAR' : 'Pedido'} #${pedido.id}</h3>
                            <p>${pedido.fecha_creacion} - ${pedido.proveedor} - ‚Ç¨${pedido.total.toFixed(3)}</p>
                        </div>
                        <div class="pedido-actions">
                            <button class="btn" onclick="toggleDetalles(${pedido.id})" title="Ver m√°s detalles" style="background-color:lightgray; color:black;box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);">
                                <span id="toggle-icon-${pedido.id}">‚ñº</span>
                            </button>
                            <button class="btn" onclick="mostrarDetalleCompleto(${pedido.id})" title="Ver detalle completo" style="background-color:white; color:black;box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);">
                                üëÅ
                            </button>
                            <button class="btn" onclick="abrirModalNota(${pedido.id})" title="A√±adir nota" style="background-color:#ffef9f; color:black;box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);">
                                üóä
                            </button>
                            <button class="btn btn-success" onclick="descargarPedidoIndividual(${pedido.id})" title="Descargar este pedido" style="box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);">
                                ü°á
                            </button>
                            <button class="btn btn-terciary" onclick="eliminarPedido(${pedido.id})" title="Eliminar pedido" style="box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);">
                                X
                            </button>
                        </div>
                    </div>

                    <div class="timeline">
                        <div class="timeline-line"></div>
                        ${ESTADOS.map((estado, index) => {
                            let claseEstado = '';
                            let circuloTexto = '';
                            
                            if (esTar && (estado === 'oferta_recibida' || estado === 'eproc_lanzado' || estado === 'eproc_firmado')) {
                                // Para TAR: primeros tres estados siempre en azul (pre-completados) sin n√∫meros
                                claseEstado = 'active-blue';
                                circuloTexto = '';
                            } else if (index <= estadoIndex) {
                                // Estados completados normalmente (verde)
                                claseEstado = 'active';
                                circuloTexto = '‚úì';
                            } else {
                                // Estados pendientes - para TAR el paso 1 empieza en packing_list (√≠ndice 3)
                                claseEstado = '';
                                if (esTar) {
                                    circuloTexto = index >= 3 ? (index - 2) : '';
                                } else {
                                    circuloTexto = index + 1;
                                }
                            }
                            
                            return `
                            <div class="timeline-step">
                                <div class="timeline-circle ${claseEstado}">
                                    ${circuloTexto}
                                </div>
                                <span class="timeline-label ${claseEstado}">
                                    ${NOMBRES_ESTADOS[estado]}
                                </span>
                            </div>
                        `}).join('')}
                    </div>

                    <div class="navigation-buttons">
                        ${pedido.estado !== 'oferta_recibida' ? `
                            <button class="btn btn-secondary" onclick="retrocederEstado(${pedido.id})">
                                ‚Üê Anterior
                            </button>
                        ` : ''}
                        
                        ${pedido.estado === 'oferta_recibida' ? `
                            <button class="btn" onclick="lanzarEproc(${pedido.id})">Lanzar Eproc</button>
                        ` : pedido.estado === 'eproc_lanzado' ? `
                            <button class="btn" onclick="firmarEproc(${pedido.id})">Firmar Eproc</button>
                        ` : pedido.estado === 'eproc_firmado' ? `
                            <button class="btn" onclick="crearPackingList(${pedido.id})">Crear Packing List</button>
                        ` : pedido.estado === 'packing_list_creado' ? `
                            <button class="btn" onclick="lanzarTar(${pedido.id})">Lanzar TAR</button>
                        ` : pedido.estado === 'tar_lanzado' ? `
                            <button class="btn" onclick="enviarEtiquetas(${pedido.id})">Enviar Etiquetas</button>
                        ` : pedido.estado === 'etiquetas_enviadas' ? `
                            <button class="btn" onclick="avanzarEstado(${pedido.id})">Paquete recogido al proveedor</button>
                        ` : pedido.estado === 'recibido_planta' ? `
                            <button class="btn" onclick="avanzarEstado(${pedido.id})">Paquete ha llegado al almac√©n</button>
                        ` : pedido.estado === 'sin_incidencias' ? `
                            <button class="btn" onclick="avanzarEstado(${pedido.id})">Paquete recogido</button>
                        ` : `
                            <span class="btn btn-success" style="cursor: default;">‚úì Completado</span>
                        `}
                    </div>

                    <div id="detalles-${pedido.id}" class="detalles-panel">
                        <h4 style="margin-bottom: 15px;">Informaci√≥n del proceso</h4>
                        
                        <div class="info-section">
                            <h5>Oferta Recibida</h5>
                            <div class="info-grid">
                                <div>
                                    <p><strong>N√∫mero:</strong> ${pedido.numero_oferta}</p>
                                    <p><strong>Proveedor:</strong> ${pedido.proveedor}</p>
                                    <p><strong>Email:</strong> ${pedido.email_proveedor || 'N/A'}</p>
                                    <p><strong>Total:</strong> ‚Ç¨${pedido.total.toFixed(3)}</p>
                                </div>
                                <div>
                                    <p><strong>Fecha:</strong> ${pedido.fecha_oferta || 'N/A'}</p>
                                </div>
                            </div>
                        </div>

                        ${(pedido.eproc || esTar) ? `
                            <div class="info-section">
                                <h5>Eproc ${esTar ? '(Pre-lanzado)' : 'Lanzado'}</h5>
                                <div class="info-grid">
                                    <div>
                                        <p><strong>N√∫mero:</strong> ${pedido.eproc?.numero || 'N/A'}</p>
                                        ${pedido.eproc?.oi ? `<p><strong>OI:</strong> ${pedido.eproc.oi}</p>` : ''}
                                        ${pedido.eproc?.short_description ? `<p><strong>Short Description:</strong> ${pedido.eproc.short_description}</p>` : ''}
                                    </div>
                                    <div>
                                        <p><strong>Fecha:</strong> ${pedido.eproc?.fecha || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${pedido.eproc_firmado ? `
                            <div class="info-section">
                                <h5>Eproc Firmado</h5>
                                <div class="info-grid">
                                    <div>
                                        <p><strong>PO:</strong> ${pedido.eproc_firmado.po}</p>
                                        <p><strong>Fecha:</strong> ${pedido.eproc_firmado.fecha}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${pedido.packing_list ? `
                            <div class="info-section">
                                <h5>Packing List</h5>
                                <div class="info-grid">
                                    <div>
                                        <p><strong>Direcci√≥n:</strong> ${pedido.packing_list.direccion}</p>
                                        <p><strong>Bultos:</strong> ${pedido.packing_list.bultos}</p>
                                        <p><strong>Peso Total:</strong> ${pedido.packing_list.peso_total || 0} kg</p>
                                    </div>
                                    <div>
                                        <p><strong>Fecha:</strong> ${pedido.packing_list.fecha || 'N/A'}</p>
                                    </div>
                                </div>
                                ${pedido.configuracion_bultos ? `
                                    <div style="margin-top: 15px;">
                                        <h6 style="color: #374151; font-weight: 600; margin-bottom: 10px;">Configuraci√≥n de Bultos:</h6>
                                        ${Object.entries(pedido.configuracion_bultos).map(([bulto, piezas]) => {
                                            const infoBulto = pedido.info_bultos && pedido.info_bultos[bulto];
                                            return `
                                                <div style="margin-bottom: 8px; padding: 8px; background: #f9fafb; border-radius: 4px;">
                                                    <strong>${bulto.replace('_', ' ').charAt(0).toUpperCase() + bulto.replace('_', ' ').slice(1)}:</strong>
                                                    ${infoBulto ? `<span style="color: #6b7280; font-size: 12px;"> (${infoBulto.peso}kg${infoBulto.dimensiones ? `, ${infoBulto.dimensiones}` : ''})</span>` : ''}
                                                    <br>
                                                    ${piezas.length > 0 ? piezas.map(p => `${p.referencia} (${p.cantidad})`).join(', ') : 'Sin asignar'}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}

                        ${pedido.tar ? `
                            <div class="info-section">
                                <h5>TAR Lanzado</h5>
                                <div class="info-grid">
                                    <div>
                                        <p><strong>N√∫mero:</strong> ${pedido.tar.numero}</p>
                                        <p><strong>Email Log√≠stica:</strong> ${pedido.tar.email}</p>
                                        <p><strong>URL:</strong> ${pedido.tar.url}</p>
                                    </div>
                                    <div>
                                        <p><strong>Fecha:</strong> ${pedido.tar.fecha || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${pedido.etiquetas ? `
                            <div class="info-section">
                                <h5>Etiquetas Enviadas</h5>
                                <div class="info-grid">
                                    <div>
                                        <p><strong>Tracking:</strong> ${pedido.etiquetas.tracking}</p>
                                        <button class="btn" onclick="consultarSeguimientoDHL('${pedido.etiquetas.tracking}')" 
                                                style="background: #ff6b00; color: white; border-color: #ff6b00; margin-top: 8px; font-size: 12px; padding: 6px 12px;">
                                            üöö Seguir en DHL
                                        </button>
                                    </div>
                                    <div>
                                        <p><strong>Fecha:</strong> ${pedido.etiquetas.fecha || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <div class="info-section">
                            <h5>Documentos</h5>
                            <div class="pdf-tags">
                                <span class="pdf-tag clickable" onclick="abrirPDF('Oferta_${pedido.numero_oferta}.pdf', '${getFileData(pedido, 'oferta')}', ${pedido.id}, 'oferta')" 
                                      title="Click para abrir PDF">üìÑ Oferta_${pedido.numero_oferta}.pdf</span>
                                ${pedido.eproc_firmado ? `<span class="pdf-tag clickable" onclick="abrirPDF('PO_${pedido.eproc_firmado.po}.pdf', '${getFileData(pedido, 'po')}', ${pedido.id}, 'po')" 
                                      title="Click para abrir PDF">üìÑ PO_${pedido.eproc_firmado.po}.pdf</span>` : ''}
                                ${pedido.packing_list ? `<span class="pdf-tag clickable" onclick="abrirPDF('PackingList_${pedido.id}.pdf', '${getFileData(pedido, 'packing')}', ${pedido.id}, 'packing')" 
                                      title="Click para abrir PDF">üìÑ PackingList_${pedido.id}.pdf</span>` : ''}
                                ${pedido.etiquetas ? `<span class="pdf-tag clickable" onclick="abrirPDF('Etiquetas_${pedido.etiquetas.tracking}.pdf', '${getFileData(pedido, 'etiquetas')}', ${pedido.id}, 'etiquetas')" 
                                      title="Click para abrir PDF">üìÑ Etiquetas_${pedido.etiquetas.tracking}.pdf</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Modal functions
        function abrirModalCrearPedido() {
            document.getElementById('modal-crear-pedido').style.display = 'block';
            
            // Limpiar completamente el formulario
            document.getElementById('form-crear-pedido').reset();
            
            // Limpiar campos espec√≠ficos manualmente
            document.getElementById('numero_oferta').value = '';
            document.getElementById('proveedor').value = '';
            document.getElementById('email_proveedor').value = '';
            document.getElementById('fecha_oferta').value = obtenerFechaHoy();
            document.getElementById('oferta_pdf').value = '';
            
            // Limpiar y reinicializar las piezas
            limpiarPiezas();
            agregarPieza();
            
            // Reinicializar el total
            document.getElementById('total-pedido').textContent = '0.000';
        }

        function abrirShortDescriptionGenerator() {
            document.getElementById('modal-short-description').style.display = 'block';
            limpiarCamposSD();
            setTimeout(() => {
                document.getElementById('sd-oferta').focus();
            }, 100);
        }

        function abrirModalCrearTar() {
            document.getElementById('modal-crear-tar').style.display = 'block';
            
            // Limpiar completamente el formulario
            document.getElementById('form-crear-tar').reset();
            
            // Limpiar campos espec√≠ficos manualmente
            document.getElementById('tar_proveedor').value = '';
            document.getElementById('tar_email_proveedor').value = '';
            document.getElementById('tar_numero_oferta').value = '';
            document.getElementById('tar_fecha_oferta').value = obtenerFechaHoy();
            document.getElementById('tar_oferta_pdf').value = '';
            
            // Valores por defecto para EPROC
            const a√±o = new Date().getFullYear();
            const numeroEproc = `EP${a√±o}-TAR-${Math.floor(Math.random() * 1000).toString().padStart(3, '0')}`;
            document.getElementById('tar_numero_eproc').value = numeroEproc;
            document.getElementById('tar_oi_eproc').value = '';
            
            // Limpiar y reinicializar las piezas TAR
            limpiarPiezasTar();
            agregarPiezaTar();
            
            // Reinicializar el total TAR
            document.getElementById('total-tar').textContent = '0.000';
        }

        function cerrarModal() {
            document.getElementById('modal-crear-pedido').style.display = 'none';
        }

        // Funciones para los nuevos modales
        function cerrarModalLanzarEproc() {
            document.getElementById('modal-lanzar-eproc').style.display = 'none';
        }

        function cerrarModalFirmarEproc() {
            document.getElementById('modal-firmar-eproc').style.display = 'none';
        }

        function cerrarModalPackingList() {
            document.getElementById('modal-packing-list').style.display = 'none';
        }

        function cerrarModalLanzarTar() {
            document.getElementById('modal-lanzar-tar').style.display = 'none';
        }

        function cerrarModalEnviarEtiquetas() {
            document.getElementById('modal-enviar-etiquetas').style.display = 'none';
        }
        
        function abrirGmailEtiquetas() {
            const pedidoId = parseInt(document.getElementById('enviar-etiquetas-pedido-id').value);
            const pedido = pedidos.find(p => p.id === pedidoId);
            
            if (pedido) {
                const trackingNumber = document.getElementById('enviar_etiquetas_tracking').value;
                const fechaEnvio = document.getElementById('enviar_etiquetas_fecha').value;
                
                // Usar la funci√≥n existente sin la confirmaci√≥n
                generarEmailEtiquetas(pedido, trackingNumber, fechaEnvio);
            } else {
                alert('Error: No se encontr√≥ informaci√≥n del pedido.');
            }
        }

        function cerrarModalDetalle() {
            document.getElementById('modal-detalle-completo').style.display = 'none';
        }

        // Funciones para notas
        let pedidoIdNota = null;

        function abrirModalNota(pedidoId) {
            pedidoIdNota = pedidoId;
            
            // Buscar el pedido para mostrar las notas existentes
            const pedido = pedidos.find(p => p.id === pedidoId);
            const modalContent = document.querySelector('#modal-nota .modal-content');
            
            // Actualizar el t√≠tulo del modal
            const titulo = modalContent.querySelector('h2');
            titulo.textContent = `Notas - Pedido #${pedidoId}`;
            
            // Mostrar notas existentes antes del formulario
            const formNota = document.getElementById('form-nota');
            
            // Remover notas existentes si las hay
            const notasExistentes = modalContent.querySelector('.notas-existentes');
            if (notasExistentes) {
                notasExistentes.remove();
            }
            
            // Crear secci√≥n de notas existentes
            if (pedido && pedido.notas && pedido.notas.length > 0) {
                const notasDiv = document.createElement('div');
                notasDiv.className = 'notas-existentes';
                notasDiv.innerHTML = `
                    <h4 style="margin-bottom: 15px; color: #374151; font-size: 14px;">Notas existentes:</h4>
                    <div style="max-height: 200px; overflow-y: auto; margin-bottom: 20px;">
                        ${pedido.notas.map((nota, index) => `
                            <div class="nota-item" style="margin-bottom: 10px; position: relative;">
                                <button class="nota-eliminar" onclick="eliminarNota(${pedidoId}, ${index})" 
                                        title="Eliminar nota"
                                        style="position: absolute; top: 8px; right: 8px; background: #fee2e2; border: 1px solid #fecaca; color: #dc2626; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0;">
                                    √ó
                                </button>
                                <div class="nota-fecha">${nota.fecha}</div>
                                <div class="nota-texto" style="padding-right: 30px;">${nota.texto}</div>
                            </div>
                        `).join('')}
                    </div>
                    <hr style="margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;">
                `;
                formNota.parentNode.insertBefore(notasDiv, formNota);
            }
            
            document.getElementById('modal-nota').style.display = 'block';
            document.getElementById('texto-nota').value = '';
            document.getElementById('texto-nota').focus();
        }

        function cerrarModalNota() {
            document.getElementById('modal-nota').style.display = 'none';
            pedidoIdNota = null;
        }

        function guardarNota() {
            const texto = document.getElementById('texto-nota').value.trim();
            
            if (!texto) {
                alert('Por favor, escribe una nota antes de guardar.');
                return;
            }

            if (!pedidoIdNota) {
                alert('Error: No se ha seleccionado un pedido.');
                return;
            }

            const pedidoIndex = pedidos.findIndex(p => p.id === pedidoIdNota);
            if (pedidoIndex === -1) {
                alert('Error: Pedido no encontrado.');
                return;
            }

            // Crear la nota con fecha actual
            const nuevaNota = {
                texto: texto,
                fecha: new Date().toLocaleString('es-ES', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                })
            };

            // A√±adir la nota al pedido
            if (!pedidos[pedidoIndex].notas) {
                pedidos[pedidoIndex].notas = [];
            }
            pedidos[pedidoIndex].notas.push(nuevaNota);

            // Guardar cambios
            localStorage.setItem('pedidos', JSON.stringify(pedidos));

            // Cerrar modal y actualizar vista
            cerrarModalNota();
            mostrarPedidos();
            
        }

        function eliminarNota(pedidoId, notaIndex) {
           

            const pedidoIndex = pedidos.findIndex(p => p.id === pedidoId);
            if (pedidoIndex === -1) {
                alert('Error: Pedido no encontrado.');
                return;
            }

            // Eliminar la nota del array
            if (pedidos[pedidoIndex].notas && pedidos[pedidoIndex].notas[notaIndex]) {
                pedidos[pedidoIndex].notas.splice(notaIndex, 1);
                
                // Si no quedan notas, eliminar el array completo
                if (pedidos[pedidoIndex].notas.length === 0) {
                    delete pedidos[pedidoIndex].notas;
                }

                // Guardar cambios
                localStorage.setItem('pedidos', JSON.stringify(pedidos));

                // Actualizar vista del modal
                abrirModalNota(pedidoId);
                
                // Actualizar vista principal
                mostrarPedidos();
            }
        }

        // Event listener para Ctrl+Enter en el textarea de notas
        document.addEventListener('DOMContentLoaded', function() {
            const textareaNota = document.getElementById('texto-nota');
            if (textareaNota) {
                textareaNota.addEventListener('keydown', function(event) {
                    if (event.ctrlKey && event.key === 'Enter') {
                        event.preventDefault();
                        guardarNota();
                    }
                });
            }
        });


        // ===============================
        // FUNCIONES PARA CREAR TAR
        // ===============================

        function cerrarModalCrearTar() {
            document.getElementById('modal-crear-tar').style.display = 'none';
        }

        function agregarPiezaTar() {
            const grid = document.getElementById('tar-pieces-grid');
            const pieceCount = grid.children.length;
            
            const pieceRow = document.createElement('div');
            pieceRow.className = 'piece-row';
            pieceRow.innerHTML = `
                <input type="text" name="referencia_${pieceCount}" placeholder="REF-001">
                <input type="text" name="descripcion_${pieceCount}" placeholder="Descripci√≥n de la pieza">
                <input type="text" name="proyecto_${pieceCount}" placeholder="Proyecto A">
                <input type="number" name="cantidad_${pieceCount}" value="1" min="1" onchange="calcularTotalTar(); actualizarTotalFilaTar(this)">
                <input type="number" name="precio_${pieceCount}" step="0.001" min="0" placeholder="0.000" onchange="calcularTotalTar(); actualizarTotalFilaTar(this)">
                <div class="total-fila" style="text-align: center; font-weight: bold; color: #059669; padding: 12px 15px; background: #f0fdf4; border-radius: 4px;">0.000</div>
                <button type="button" class="btn btn-terciary" onclick="eliminarPiezaTar(this)" style="padding: 10px 15px; font-size: 14px; font-weight: bold; width: 100%;">√ó</button>
            `;
            
            grid.appendChild(pieceRow);
        }

        function eliminarPiezaTar(button) {
            button.parentElement.remove();
            calcularTotalTar();
        }

        function limpiarPiezasTar() {
            const grid = document.getElementById('tar-pieces-grid');
            while (grid.children.length > 1) {
                grid.removeChild(grid.lastChild);
            }
            // Reiniciar el total TAR a 0
            document.getElementById('total-tar').textContent = '0.000';
        }

        function calcularTotalTar() {
            const grid = document.getElementById('tar-pieces-grid');
            let total = 0;
            
            for (let i = 1; i < grid.children.length; i++) {
                const row = grid.children[i];
                const cantidad = parseFloat(row.children[3].value) || 0;
                const precio = parseFloat(row.children[4].value) || 0;
                const subtotal = cantidad * precio;
                total += subtotal;
                
                // Actualizar total de la fila
                if (row.children[5]) {
                    row.children[5].textContent = subtotal.toFixed(3);
                }
            }
            
            document.getElementById('total-tar').textContent = total.toFixed(3);
        }

        // Funciones para actualizar totales individuales por fila
        function actualizarTotalFila(input) {
            const row = input.parentElement;
            const cantidad = parseFloat(row.children[3].value) || 0;
            const precio = parseFloat(row.children[4].value) || 0;
            const total = cantidad * precio;
            row.children[5].textContent = total.toFixed(3);
        }

        function actualizarTotalFilaTar(input) {
            const row = input.parentElement;
            const cantidad = parseFloat(row.children[3].value) || 0;
            const precio = parseFloat(row.children[4].value) || 0;
            const total = cantidad * precio;
            row.children[5].textContent = total.toFixed(3);
        }

        // Funci√≥n para mostrar detalle completo en modal
        function mostrarDetalleCompleto(pedidoId) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            if (!pedido) return;

            const esTar = pedido.tipo === 'TAR';
            const titulo = esTar ? `Detalles del TAR #${pedido.id}` : `Detalles del Pedido #${pedido.id}`;
            document.getElementById('detalle-titulo').textContent = titulo;
            
            const contenido = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="info-section">
                        <h3 style="color: #374151; margin-bottom: 15px; font-size: 18px;">üìã Informaci√≥n General</h3>
                        <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                            <p><strong>ID:</strong> ${pedido.id}</p>
                            <p><strong>N√∫mero de Oferta:</strong> ${pedido.numero_oferta}</p>
                            <p><strong>Proveedor:</strong> ${pedido.proveedor}</p>
                            <p><strong>Email Proveedor:</strong> ${pedido.email_proveedor || 'N/A'}</p>
                            <p><strong>Fecha Creaci√≥n:</strong> ${pedido.fecha_creacion}</p>
                            <p><strong>Fecha Oferta:</strong> ${pedido.fecha_oferta || 'N/A'}</p>
                            <p><strong>Estado Actual:</strong> <span style="color: #10b981; font-weight: bold;">${getNombreEstadoTexto(pedido.estado)}</span></p>
                            <p><strong>Total:</strong> <span style="color: #059669; font-weight: bold;">‚Ç¨${pedido.total.toFixed(3)}</span></p>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <h3 style="color: #374151; margin-bottom: 15px; font-size: 18px;">üì¶ Piezas del Pedido</h3>
                        <div style="background: #f9fafb; padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto;">
                            ${pedido.piezas.map(pieza => `
                                <div style="border-bottom: 1px solid #e5e7eb; padding: 8px 0;">
                                    <p style="margin: 2px 0;"><strong>${pieza.referencia}</strong> - ${pieza.descripcion}</p>
                                    <p style="margin: 2px 0; font-size: 12px; color: #6b7280;">Proyecto: ${pieza.proyecto} | Cantidad: ${pieza.cantidad} | Precio: ‚Ç¨${pieza.precio_unitario.toFixed(3)}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                ${pedido.eproc ? `
                    <div class="info-section" style="margin-bottom: 20px;">
                        <h3 style="color: #374151; margin-bottom: 10px; font-size: 16px;">üöÄ EPROC Lanzado</h3>
                        <div style="background: #dbeafe; padding: 12px; border-radius: 6px;">
                            <p><strong>N√∫mero:</strong> ${pedido.eproc.numero}</p>
                            <p><strong>OI:</strong> ${pedido.eproc.oi || 'N/A'}</p>
                            ${pedido.eproc.short_description ? `<p><strong>Short Description:</strong> ${pedido.eproc.short_description}</p>` : ''}
                            <p><strong>Fecha:</strong> ${pedido.eproc.fecha || 'N/A'}</p>
                        </div>
                    </div>
                ` : ''}

                ${pedido.eproc_firmado ? `
                    <div class="info-section" style="margin-bottom: 20px;">
                        <h3 style="color: #374151; margin-bottom: 10px; font-size: 16px;">‚úçÔ∏è EPROC Firmado</h3>
                        <div style="background: #dcfce7; padding: 12px; border-radius: 6px;">
                            <p><strong>N√∫mero PO:</strong> ${pedido.eproc_firmado.po}</p>
                            <p><strong>Fecha:</strong> ${pedido.eproc_firmado.fecha}</p>
                            <p><strong>PDF:</strong> ${pedido.eproc_firmado.pdf || 'N/A'}</p>
                        </div>
                    </div>
                ` : ''}

                ${pedido.packing_list ? `
                    <div class="info-section" style="margin-bottom: 20px;">
                        <h3 style="color: #374151; margin-bottom: 10px; font-size: 16px;">üì¶ Packing List</h3>
                        <div style="background: #fef3c7; padding: 12px; border-radius: 6px;">
                            <p><strong>Direcci√≥n:</strong> ${pedido.packing_list.direccion}</p>
                            <p><strong>N√∫mero de Bultos:</strong> ${pedido.packing_list.bultos}</p>
                            <p><strong>Peso Total:</strong> ${pedido.packing_list.peso_total || 0} kg</p>
                            <p><strong>Fecha:</strong> ${pedido.packing_list.fecha || 'N/A'}</p>
                            <p><strong>PDF:</strong> ${pedido.packing_list.pdf || 'N/A'}</p>
                            ${pedido.configuracion_bultos ? `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                    <p style="font-weight: 600; margin-bottom: 10px;">Configuraci√≥n de Bultos:</p>
                                    ${Object.entries(pedido.configuracion_bultos).map(([bulto, piezas]) => {
                                        const infoBulto = pedido.info_bultos && pedido.info_bultos[bulto];
                                        return `
                                            <div style="margin-bottom: 10px; padding: 10px; background: #fffbeb; border-radius: 6px; border-left: 4px solid #f59e0b;">
                                                <p style="font-weight: 600; color: #92400e;">
                                                    ${bulto.replace('_', ' ').charAt(0).toUpperCase() + bulto.replace('_', ' ').slice(1)}
                                                    ${infoBulto ? `<span style="font-weight: normal; color: #6b7280;"> - ${infoBulto.peso}kg${infoBulto.dimensiones ? `, ${infoBulto.dimensiones}` : ''}</span>` : ''}
                                                </p>
                                                <p style="margin-top: 5px; color: #451a03;">
                                                    ${piezas.length > 0 ? piezas.map(p => `${p.referencia} - ${p.descripcion} (Cant: ${p.cantidad})`).join('<br>') : 'Sin piezas asignadas'}
                                                </p>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                ` : ''}

                ${pedido.tar ? `
                    <div class="info-section" style="margin-bottom: 20px;">
                        <h3 style="color: #374151; margin-bottom: 10px; font-size: 16px;">üöö TAR Lanzado</h3>
                        <div style="background: #fce7f3; padding: 12px; border-radius: 6px;">
                            <p><strong>N√∫mero TAR:</strong> ${pedido.tar.numero}</p>
                            <p><strong>Email Log√≠stica:</strong> ${pedido.tar.email}</p>
                            <p><strong>URL:</strong> ${pedido.tar.url || 'N/A'}</p>
                            <p><strong>Fecha:</strong> ${pedido.tar.fecha || 'N/A'}</p>
                        </div>
                    </div>
                ` : ''}

                ${pedido.etiquetas ? `
                    <div class="info-section" style="margin-bottom: 20px;">
                        <h3 style="color: #374151; margin-bottom: 10px; font-size: 16px;">üè∑Ô∏è Etiquetas Enviadas</h3>
                        <div style="background: #e0e7ff; padding: 12px; border-radius: 6px;">
                            <p><strong>Tracking:</strong> ${pedido.etiquetas.tracking}</p>
                            <button class="btn" onclick="consultarSeguimientoDHL('${pedido.etiquetas.tracking}')" 
                                    style="background: #ff6b00; color: white; border-color: #ff6b00; margin: 10px 0; font-size: 12px; padding: 6px 12px;">
                                üöö Seguir en DHL
                            </button>
                            <p><strong>Fecha:</strong> ${pedido.etiquetas.fecha || 'N/A'}</p>
                            <p><strong>PDF:</strong> ${pedido.etiquetas.pdf || 'N/A'}</p>
                        </div>
                    </div>
                ` : ''}

                <div class="info-section">
                    <h3 style="color: #374151; margin-bottom: 10px; font-size: 16px;">üìÑ Documentos</h3>
                    <div style="background: #f3f4f6; padding: 15px; border-radius: 6px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <span class="pdf-tag clickable" onclick="abrirPDF('Oferta_${pedido.numero_oferta}.pdf', '${getFileData(pedido, 'oferta')}')" 
                                  title="Click para abrir PDF">üìÑ Oferta_${pedido.numero_oferta}.pdf</span>
                            ${pedido.eproc_firmado ? `<span class="pdf-tag clickable" onclick="abrirPDF('PO_${pedido.eproc_firmado.po}.pdf', '${getFileData(pedido, 'po')}')" 
                                  title="Click para abrir PDF">üìÑ PO_${pedido.eproc_firmado.po}.pdf</span>` : ''}
                            ${pedido.packing_list ? `<span class="pdf-tag clickable" onclick="abrirPDF('PackingList_${pedido.id}.pdf', '${getFileData(pedido, 'packing')}')" 
                                  title="Click para abrir PDF">üìÑ PackingList_${pedido.id}.pdf</span>` : ''}
                            ${pedido.etiquetas ? `<span class="pdf-tag clickable" onclick="abrirPDF('Etiquetas_${pedido.etiquetas.tracking}.pdf', '${getFileData(pedido, 'etiquetas')}')" 
                                  title="Click para abrir PDF">üìÑ Etiquetas_${pedido.etiquetas.tracking}.pdf</span>` : ''}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('detalle-contenido').innerHTML = contenido;
            document.getElementById('modal-detalle-completo').style.display = 'block';
        }

        // Funciones de piezas
        function agregarPieza() {
            const grid = document.getElementById('pieces-grid');
            const pieceCount = grid.children.length;
            
            const pieceRow = document.createElement('div');
            pieceRow.className = 'piece-row';
            pieceRow.innerHTML = `
                <input type="text" name="referencia_${pieceCount}" placeholder="REF-001">
                <input type="text" name="descripcion_${pieceCount}" placeholder="Descripci√≥n de la pieza">
                <input type="text" name="proyecto_${pieceCount}" placeholder="Proyecto A">
                <input type="number" name="cantidad_${pieceCount}" value="1" min="1" onchange="calcularTotal(); actualizarTotalFila(this)">
                <input type="number" name="precio_${pieceCount}" step="0.001" min="0" placeholder="0.000" onchange="calcularTotal(); actualizarTotalFila(this)">
                <div class="total-fila" style="text-align: center; font-weight: bold; color: #059669; padding: 12px 15px; background: #f0fdf4; border-radius: 4px;">0.000</div>
                <button type="button" class="btn btn-terciary" onclick="eliminarPieza(this)" style="padding: 10px 15px; font-size: 14px; font-weight: bold; width: 100%;">√ó</button>
            `;
            
            grid.appendChild(pieceRow);
        }

        function eliminarPieza(button) {
            button.parentElement.remove();
            calcularTotal();
        }

        function limpiarPiezas() {
            const grid = document.getElementById('pieces-grid');
            while (grid.children.length > 1) {
                grid.removeChild(grid.lastChild);
            }
            // Reiniciar el total a 0
            document.getElementById('total-pedido').textContent = '0.000';
        }

        function calcularTotal() {
            const grid = document.getElementById('pieces-grid');
            let total = 0;
            
            for (let i = 1; i < grid.children.length; i++) {
                const row = grid.children[i];
                const cantidad = parseFloat(row.children[3].value) || 0;
                const precio = parseFloat(row.children[4].value) || 0;
                const subtotal = cantidad * precio;
                total += subtotal;
                
                // Actualizar total de la fila
                if (row.children[5]) {
                    row.children[5].textContent = subtotal.toFixed(3);
                }
            }
            
            document.getElementById('total-pedido').textContent = total.toFixed(3);
        }

        // Toggle detalles
        function toggleDetalles(pedidoId) {
            const detalles = document.getElementById(`detalles-${pedidoId}`);
            const icon = document.getElementById(`toggle-icon-${pedidoId}`);
            
            if (detalles.classList.contains('show')) {
                detalles.classList.remove('show');
                icon.textContent = '‚ñº';
            } else {
                detalles.classList.add('show');
                icon.textContent = '‚ñ≤';
            }
        }

        // Funciones espec√≠ficas para cada estado
        function lanzarEproc(pedidoId) {
            document.getElementById('modal-lanzar-eproc').style.display = 'block';
            document.getElementById('lanzar-eproc-pedido-id').value = pedidoId;
            
            // Valores por defecto
            const a√±o = new Date().getFullYear();
            document.getElementById('lanzar_eproc_numero').value = `EP${a√±o}-${pedidoId.toString().padStart(3, '0')}`;
            document.getElementById('lanzar_eproc_fecha').value = obtenerFechaHoy();
        }

        function firmarEproc(pedidoId) {
            document.getElementById('modal-firmar-eproc').style.display = 'block';
            document.getElementById('firmar-eproc-pedido-id').value = pedidoId;
            document.getElementById('firmar_eproc_fecha').value = obtenerFechaHoy();
        }

        function crearPackingList(pedidoId) {
            document.getElementById('modal-packing-list').style.display = 'block';
            document.getElementById('packing-list-pedido-id').value = pedidoId;
            document.getElementById('packing_list_fecha').value = obtenerFechaHoy();
            
            // Resetear configuraci√≥n de bultos
            document.getElementById('configuracion-bultos-container').style.display = 'none';
            document.getElementById('packing_list_bultos').value = '';
        }

        function generarConfiguracionBultos() {
            const numBultos = parseInt(document.getElementById('packing_list_bultos').value);
            const pedidoId = parseInt(document.getElementById('packing-list-pedido-id').value);
            const pedido = pedidos.find(p => p.id === pedidoId);
            
            if (!numBultos || !pedido) {
                document.getElementById('configuracion-bultos-container').style.display = 'none';
                return;
            }

            document.getElementById('configuracion-bultos-container').style.display = 'block';
            
            // Inicializar datos globales para la configuraci√≥n
            window.piezasDisponibles = [...pedido.piezas];
            window.configuracionBultos = {};
            window.infoBultos = {};
            
            // Inicializar bultos vac√≠os con informaci√≥n adicional
            for (let i = 1; i <= numBultos; i++) {
                window.configuracionBultos[`bulto_${i}`] = [];
                window.infoBultos[`bulto_${i}`] = {
                    peso: 0,
                    dimensiones: ''
                };
            }
            
            // Llenar selector de bultos
            const selector = document.getElementById('bulto-selector');
            selector.innerHTML = '';
            for (let i = 1; i <= numBultos; i++) {
                const option = document.createElement('option');
                option.value = `bulto_${i}`;
                option.textContent = `Bulto ${i}`;
                selector.appendChild(option);
            }
            
            // Cargar primera vista
            mostrarPiezasDisponibles();
            mostrarContenidoBulto();
            cargarInfoBulto();
            
            // Event listener para cambio de bulto
            selector.onchange = () => {
                mostrarContenidoBulto();
                cargarInfoBulto();
            };
        }

        function mostrarPiezasDisponibles() {
            const container = document.getElementById('piezas-disponibles');
            container.innerHTML = '';
            
            window.piezasDisponibles.forEach((pieza, index) => {
                const div = document.createElement('div');
                div.className = 'pieza-item';
                div.style.cssText = `
                    padding: 10px;
                    margin: 5px 0;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    background: white;
                    cursor: pointer;
                    transition: all 0.2s;
                `;
                div.onclick = () => seleccionarPieza(div, index);
                div.innerHTML = `
                    <div style="font-weight: 600; color: #374151;">${pieza.referencia}</div>
                    <div style="font-size: 12px; color: #6b7280;">${pieza.descripcion}</div>
                    <div style="font-size: 12px; color: #059669;">Cantidad: ${pieza.cantidad}</div>
                `;
                container.appendChild(div);
            });
        }

        function mostrarContenidoBulto() {
            const selector = document.getElementById('bulto-selector');
            const bultoSeleccionado = selector.value;
            const container = document.getElementById('bulto-contenido');
            
            if (!bultoSeleccionado) return;
            
            const piezasEnBulto = window.configuracionBultos[bultoSeleccionado] || [];
            container.innerHTML = '';
            
            if (piezasEnBulto.length === 0) {
                container.innerHTML = `
                    <p style="color: #9ca3af; text-align: center; margin-top: 50px;">
                        Este bulto est√° vac√≠o.<br>
                        Seleccione piezas de la izquierda y use el bot√≥n ‚Üí para agregar.
                    </p>
                `;
                return;
            }
            
            piezasEnBulto.forEach((pieza, index) => {
                const div = document.createElement('div');
                div.className = 'pieza-en-bulto';
                div.style.cssText = `
                    padding: 10px;
                    margin: 5px 0;
                    border: 1px solid #10b981;
                    border-radius: 6px;
                    background: #ecfdf5;
                    cursor: pointer;
                    transition: all 0.2s;
                `;
                div.onclick = () => seleccionarPiezaEnBulto(div, index);
                div.innerHTML = `
                    <div style="font-weight: 600; color: #065f46;">${pieza.referencia}</div>
                    <div style="font-size: 12px; color: #047857;">${pieza.descripcion}</div>
                    <div style="font-size: 12px; color: #059669;">Cantidad: ${pieza.cantidad}</div>
                `;
                container.appendChild(div);
            });
        }

        function cargarInfoBulto() {
            const selector = document.getElementById('bulto-selector');
            const bultoSeleccionado = selector.value;
            const infoContainer = document.getElementById('info-bulto-container');
            
            if (!bultoSeleccionado) {
                infoContainer.style.display = 'none';
                return;
            }
            
            infoContainer.style.display = 'block';
            
            const infoBulto = window.infoBultos[bultoSeleccionado];
            document.getElementById('bulto-peso').value = infoBulto.peso;
            document.getElementById('bulto-dimensiones').value = infoBulto.dimensiones;
        }

        function actualizarInfoBulto() {
            const selector = document.getElementById('bulto-selector');
            const bultoSeleccionado = selector.value;
            
            if (!bultoSeleccionado) return;
            
            const peso = parseFloat(document.getElementById('bulto-peso').value) || 0;
            const dimensiones = document.getElementById('bulto-dimensiones').value || '';
            
            window.infoBultos[bultoSeleccionado] = {
                peso: peso,
                dimensiones: dimensiones
            };
            
            // Actualizar peso total autom√°ticamente
            actualizarPesoTotal();
        }

        function actualizarPesoTotal() {
            let pesoTotal = 0;
            Object.values(window.infoBultos || {}).forEach(info => {
                pesoTotal += info.peso || 0;
            });
            
            document.getElementById('packing_list_peso_total').value = pesoTotal.toFixed(1);
        }

        function seleccionarPieza(elemento, index) {
            // Limpiar selecciones anteriores
            document.querySelectorAll('.pieza-item').forEach(item => {
                item.style.background = 'white';
                item.style.borderColor = '#d1d5db';
            });
            document.querySelectorAll('.pieza-en-bulto').forEach(item => {
                item.style.background = '#ecfdf5';
                item.style.borderColor = '#10b981';
            });
            
            // Seleccionar elemento actual
            elemento.style.background = '#dbeafe';
            elemento.style.borderColor = '#3b82f6';
            window.piezaSeleccionadaIndex = index;
            window.piezaSeleccionadaEnBulto = null;
        }

        function seleccionarPiezaEnBulto(elemento, index) {
            // Limpiar selecciones anteriores
            document.querySelectorAll('.pieza-item').forEach(item => {
                item.style.background = 'white';
                item.style.borderColor = '#d1d5db';
            });
            document.querySelectorAll('.pieza-en-bulto').forEach(item => {
                item.style.background = '#ecfdf5';
                item.style.borderColor = '#10b981';
            });
            
            // Seleccionar elemento actual
            elemento.style.background = '#fef3c7';
            elemento.style.borderColor = '#f59e0b';
            window.piezaSeleccionadaEnBulto = index;
            window.piezaSeleccionadaIndex = null;
        }

        function moverPiezaABulto() {
            if (window.piezaSeleccionadaIndex === null || window.piezaSeleccionadaIndex === undefined) {
                alert('Seleccione una pieza de la lista de disponibles');
                return;
            }
            
            const selector = document.getElementById('bulto-selector');
            const bultoSeleccionado = selector.value;
            
            if (!bultoSeleccionado) {
                alert('Seleccione un bulto');
                return;
            }
            
            // Mover pieza
            const pieza = window.piezasDisponibles[window.piezaSeleccionadaIndex];
            window.configuracionBultos[bultoSeleccionado].push(pieza);
            window.piezasDisponibles.splice(window.piezaSeleccionadaIndex, 1);
            
            // Actualizar vistas
            mostrarPiezasDisponibles();
            mostrarContenidoBulto();
            
            // Limpiar selecci√≥n
            window.piezaSeleccionadaIndex = null;
        }

        function regresarPiezaADisponibles() {
            if (window.piezaSeleccionadaEnBulto === null || window.piezaSeleccionadaEnBulto === undefined) {
                alert('Seleccione una pieza del bulto');
                return;
            }
            
            const selector = document.getElementById('bulto-selector');
            const bultoSeleccionado = selector.value;
            
            if (!bultoSeleccionado) return;
            
            // Mover pieza de vuelta
            const pieza = window.configuracionBultos[bultoSeleccionado][window.piezaSeleccionadaEnBulto];
            window.piezasDisponibles.push(pieza);
            window.configuracionBultos[bultoSeleccionado].splice(window.piezaSeleccionadaEnBulto, 1);
            
            // Actualizar vistas
            mostrarPiezasDisponibles();
            mostrarContenidoBulto();
            
            // Limpiar selecci√≥n
            window.piezaSeleccionadaEnBulto = null;
        }

        function lanzarTar(pedidoId) {
            document.getElementById('modal-lanzar-tar').style.display = 'block';
            document.getElementById('lanzar-tar-pedido-id').value = pedidoId;
            document.getElementById('lanzar_tar_numero').value = `TAR-${pedidoId}`;
            document.getElementById('lanzar_tar_email').value = 'logistica@empresa.com';
            document.getElementById('lanzar_tar_fecha').value = obtenerFechaHoy();
        }

        function enviarEtiquetas(pedidoId) {
            document.getElementById('modal-enviar-etiquetas').style.display = 'block';
            document.getElementById('enviar-etiquetas-pedido-id').value = pedidoId;
            document.getElementById('enviar_etiquetas_fecha').value = obtenerFechaHoy();
            // Limpiar el campo de direcci√≥n de recogida (sin valor por defecto)
            document.getElementById('enviar_etiquetas_direccion_envio').value = '';
        }

        function eliminarPedido(pedidoId) {
            pedidos = pedidos.filter(p => p.id !== pedidoId);
            guardarDatos();
            mostrarPedidos();
        }

        // ===============================
        // FUNCIONES PARA SEGUIMIENTO DHL
        // ===============================

        function abrirModalSeguimiento() {
            document.getElementById('modal-seguimiento-dhl').style.display = 'block';
            document.getElementById('tracking-input').value = '';
            document.getElementById('dhl-frame-container').style.display = 'none';
            document.getElementById('instrucciones-iniciales').style.display = 'block';
            
            // Inicializar entradas DHL
            inicializarEntradasDHL();
            
            // Enfocar el input de tracking
            setTimeout(() => {
                document.getElementById('tracking-input').focus();
            }, 100);
        }

        function cerrarModalSeguimiento() {
            document.getElementById('modal-seguimiento-dhl').style.display = 'none';
            // Limpiar el contenido de seguimiento
            document.getElementById('dhl-frame-container').style.display = 'none';
            document.getElementById('instrucciones-iniciales').style.display = 'block';
        }

        function consultarSeguimientoDHL(trackingNumber) {
            // Si se llama desde un pedido espec√≠fico, abrir modal y usar ese tracking
            if (trackingNumber) {
                abrirModalSeguimiento();
                document.getElementById('tracking-input').value = trackingNumber;
                setTimeout(() => {
                    consultarAPIDHL();
                }, 500);
            } else {
                abrirModalSeguimiento();
            }
        }

        async function abrirSeguimientoDHL() {
            await consultarAPIDHL();
        }

        async function consultarAPIDHL() {
            const trackingNumber = document.getElementById('tracking-input').value.trim();
            
            if (!trackingNumber) {
                alert('‚ùå Por favor, ingresa un n√∫mero de tracking v√°lido');
                return;
            }

            // Validar formato b√°sico del tracking
            if (trackingNumber.length < 4) {
                alert('‚ùå El n√∫mero de tracking parece ser muy corto. Verifica que sea correcto.');
                return;
            }

            // Mostrar estado de carga
            mostrarEstadoCarga();

            try {
                // Llamar a la API de DHL
                const datos = await obtenerDatosDHL(trackingNumber);
                mostrarResultadosSeguimiento(datos);
            } catch (error) {
                console.error('Error al consultar DHL:', error);
                mostrarErrorSeguimiento(error.message);
            }
        }

        async function obtenerDatosDHL(trackingNumber) {
            // Configuraci√≥n de la API de DHL Unified Tracking
            const API_KEY = 'wBZWFUC9AUaFCd8WVDsWp19wmAXhpVQo'; // ‚úÖ NEW UNIFIED API KEY
            const API_URL = 'https://api-eu.dhl.com/track/shipments'; // DHL Unified Tracking API
            
            // C√≥digo para API real de DHL Unified Tracking
            console.log('üü¢ Consultando API DHL Unified Tracking...');
            console.log('üîç Tracking Number:', trackingNumber);
            console.log('üîë API Key (primeros 8 chars):', API_KEY.substring(0, 8) + '...');
            
            // URL correcta para DHL Unified Tracking
            const queryParams = new URLSearchParams({
                trackingNumber: trackingNumber
            });
            const fullURL = `${API_URL}?${queryParams}`;
            console.log('üåê URL completa:', fullURL);
            
            const response = await fetch(fullURL, {
                method: 'GET',
                headers: {
                    'DHL-API-Key': API_KEY,
                    'Accept': 'application/json',
                    'Accept-Language': 'es-ES'
                }
            });

            console.log('üì° Response status:', response.status);
            console.log('üì° Response statusText:', response.statusText);

            // Obtener headers de respuesta para debugging
            const responseHeaders = {};
            for (let [key, value] of response.headers.entries()) {
                responseHeaders[key] = value;
            }
            console.log('üì° Response headers:', responseHeaders);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå Error response body:', errorText);
                
                if (response.status === 401) {
                    throw new Error('‚ùå API Key inv√°lida o no autorizada. Tu API est√° "pending" - espera a que se active.');
                } else if (response.status === 404) {
                    throw new Error('‚ùå N√∫mero de tracking no encontrado en DHL.');
                } else if (response.status === 429) {
                    throw new Error('‚ùå L√≠mite de consultas excedido (250/d√≠a). Espera hasta ma√±ana.');
                } else if (response.status === 403) {
                    throw new Error('‚ùå Acceso denegado. Tu API Key est√° en estado "pending" - contacta a DHL.');
                } else if (response.status === 400) {
                    throw new Error('‚ùå Formato de tracking number inv√°lido.');
                }
                throw new Error(`‚ùå Error HTTP ${response.status}: ${response.statusText}. Body: ${errorText}`);
            }

            const data = await response.json();
            console.log('üì¶ Datos RAW recibidos de DHL:', data);
            
            // Verificar estructura de datos
            if (!data.shipments || data.shipments.length === 0) {
                console.warn('‚ö†Ô∏è No se encontraron shipments en la respuesta');
                throw new Error('No se encontr√≥ informaci√≥n para este n√∫mero de tracking');
            }

            // Procesar con la funci√≥n est√°ndar de DHL
            return procesarDatosAPIDHL(data.shipments[0]);
        }

        function procesarDatosAPIDHL(shipment) {
            // Procesar datos reales de la API de DHL
            console.log('üì¶ Procesando datos reales de DHL API');
            
            return {
                trackingNumber: shipment.id,
                status: {
                    statusCode: shipment.status.statusCode,
                    status: shipment.status.status,
                    description: shipment.status.description || 'Sin descripci√≥n disponible'
                },
                service: shipment.service || 'DHL Express',
                origin: shipment.origin || {
                    address: {
                        addressLocality: 'Origen no disponible',
                        countryCode: 'XX',
                        country: 'No disponible'
                    }
                },
                destination: shipment.destination || {
                    address: {
                        addressLocality: 'Destino no disponible',
                        countryCode: 'XX',
                        country: 'No disponible'
                    }
                },
                estimatedDeliveryDate: shipment.estimatedTimeOfDelivery || null,
                events: shipment.events ? shipment.events.map(event => ({
                    timestamp: event.timestamp,
                    location: event.location || {
                        address: {
                            addressLocality: 'Ubicaci√≥n no disponible',
                            countryCode: 'XX'
                        }
                    },
                    statusCode: event.statusCode,
                    status: event.status,
                    description: event.description || 'Sin descripci√≥n'
                })) : []
            };
        }

        function procesarDatosGlobalForwarding(data, trackingNumber) {
            // Procesar datos reales de DHL Global Forwarding API
            console.log('üì¶ Procesando datos de DHL Global Forwarding API');
            
            // DHL Global Forwarding tiene una estructura diferente
            const shipment = data.shipment || data;
            
            return {
                trackingNumber: trackingNumber,
                status: {
                    statusCode: shipment.status?.statusCode || 'unknown',
                    status: shipment.status?.status || shipment.shipmentStatus || 'En Proceso',
                    description: shipment.status?.description || shipment.statusDescription || 'Informaci√≥n de seguimiento disponible'
                },
                service: shipment.service || shipment.productName || 'DHL Global Forwarding',
                origin: {
                    address: {
                        addressLocality: shipment.origin?.address?.addressLocality || shipment.originLocation || 'Origen no disponible',
                        countryCode: shipment.origin?.address?.countryCode || 'XX',
                        country: shipment.origin?.address?.country || 'No disponible'
                    }
                },
                destination: {
                    address: {
                        addressLocality: shipment.destination?.address?.addressLocality || shipment.destinationLocation || 'Destino no disponible',
                        countryCode: shipment.destination?.address?.countryCode || 'XX',
                        country: shipment.destination?.address?.country || 'No disponible'
                    }
                },
                estimatedDeliveryDate: shipment.estimatedDeliveryDate || shipment.estimatedTimeOfDelivery || null,
                events: (shipment.events || shipment.trackingEvents || []).map(event => ({
                    timestamp: event.timestamp || event.eventTime || new Date().toISOString(),
                    location: {
                        address: {
                            addressLocality: event.location?.address?.addressLocality || event.location || 'Ubicaci√≥n no disponible',
                            countryCode: event.location?.address?.countryCode || 'XX'
                        }
                    },
                    statusCode: event.statusCode || event.eventCode || 'info',
                    status: event.status || event.eventDescription || 'Evento',
                    description: event.description || event.eventDetails || 'Informaci√≥n del evento'
                }))
            };
        }

        function mostrarEstadoCarga() {
            document.getElementById('instrucciones-iniciales').style.display = 'none';
            document.getElementById('dhl-frame-container').style.display = 'block';
            
            const container = document.getElementById('dhl-frame-container');
            container.innerHTML = `
                <div style="background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 40px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
                    <h3 style="color: #374151; margin-bottom: 10px;">Consultando seguimiento...</h3>
                    <p style="color: #6b7280;">Obteniendo informaci√≥n actualizada desde DHL</p>
                    <div style="margin-top: 20px;">
                        <div style="width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
                            <div style="width: 100%; height: 100%; background: #ff6b00; animation: loading 2s infinite;"></div>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes loading {
                        0% { transform: translateX(-100%); }
                        100% { transform: translateX(100%); }
                    }
                </style>
            `;
        }

        function mostrarResultadosSeguimiento(datos) {
            const trackingNumber = datos.trackingNumber;
            const status = datos.status;
            const service = datos.service;
            const origin = datos.origin;
            const destination = datos.destination;
            const estimatedDate = datos.estimatedDeliveryDate;
            const events = datos.events || [];

            const container = document.getElementById('dhl-frame-container');
            container.innerHTML = `
                <div style="background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <div style="background: #ff6b00; color: white; padding: 20px; text-align: center;">
                        <h3 style="margin: 0; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <span>üì¶</span>
                            Seguimiento DHL - ${trackingNumber}
                            <span>üöö</span>
                        </h3>
                    </div>
                    
                    <!-- Informaci√≥n del env√≠o -->
                    <div style="padding: 20px; background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div>
                                <h4 style="color: #374151; margin-bottom: 10px;">üìã Estado Actual</h4>
                                <p style="font-size: 18px; font-weight: bold; color: ${obtenerColorEstado(status.statusCode)}; margin: 5px 0;">
                                    ${status.status}
                                </p>
                                <p style="color: #6b7280; font-size: 14px;">${status.description}</p>
                            </div>
                            
                            <div>
                                <h4 style="color: #374151; margin-bottom: 10px;">üöö Servicio</h4>
                                <p style="color: #374151; margin: 5px 0;">${service}</p>
                                ${estimatedDate ? `<p style="color: #6b7280; font-size: 14px;">Entrega estimada: ${formatearFecha(estimatedDate)}</p>` : ''}
                            </div>
                            
                            <div>
                                <h4 style="color: #374151; margin-bottom: 10px;">üìç Ruta</h4>
                                <p style="color: #374151; margin: 5px 0;">
                                    <strong>Origen:</strong> ${origin.address.addressLocality}, ${origin.address.country}
                                </p>
                                <p style="color: #374151; margin: 5px 0;">
                                    <strong>Destino:</strong> ${destination.address.addressLocality}, ${destination.address.country}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Timeline de eventos -->
                    <div style="padding: 20px;">
                        <h4 style="color: #374151; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            üìã Historial de Seguimiento
                        </h4>
                        <div style="position: relative;">
                            ${events.map((evento, index) => `
                                <div style="display: flex; margin-bottom: 20px; position: relative;">
                                    <div style="
                                        width: 40px; 
                                        height: 40px; 
                                        border-radius: 50%; 
                                        background: ${obtenerColorEstado(evento.statusCode)}; 
                                        color: white; 
                                        display: flex; 
                                        align-items: center; 
                                        justify-content: center; 
                                        font-size: 18px; 
                                        margin-right: 15px;
                                        flex-shrink: 0;
                                        z-index: 2;
                                        position: relative;
                                    ">
                                        ${obtenerIconoEstado(evento.statusCode)}
                                    </div>
                                    ${index < events.length - 1 ? `
                                        <div style="
                                            position: absolute;
                                            left: 19px;
                                            top: 40px;
                                            width: 2px;
                                            height: 40px;
                                            background: #e5e7eb;
                                            z-index: 1;
                                        "></div>
                                    ` : ''}
                                    <div style="flex: 1;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                                            <strong style="color: #374151; font-size: 16px;">${evento.status}</strong>
                                            <span style="color: #6b7280; font-size: 14px;">${formatearFechaHora(evento.timestamp)}</span>
                                        </div>
                                        <p style="color: #374151; margin: 5px 0; font-size: 14px;">${evento.description}</p>
                                        <p style="color: #6b7280; font-size: 12px; margin: 0;">
                                            üìç ${evento.location.address.addressLocality}${evento.location.address.countryCode ? `, ${evento.location.address.countryCode}` : ''}
                                        </p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Enlace a DHL oficial -->
                    <div style="background: #f9fafb; padding: 15px; text-align: center; border-top: 1px solid #e5e7eb;">
                        <p style="color: #6b7280; font-size: 14px; margin: 0;">
                            üí° Para m√°s detalles, consulta directamente en 
                            <a href="https://www.dhl.com/es-es/home/tracking.html?tracking-id=${trackingNumber}" 
                               target="_blank" 
                               style="color: #ff6b00; text-decoration: none; font-weight: 500;">
                                DHL.com
                            </a>
                        </p>
                    </div>
                </div>
            `;
        }

        function mostrarErrorSeguimiento(mensaje) {
            const container = document.getElementById('dhl-frame-container');
            container.innerHTML = `
                <div style="background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 40px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
                    <h3 style="color: #dc2626; margin-bottom: 15px;">Error al consultar seguimiento</h3>
                    <p style="color: #6b7280; margin-bottom: 20px;">${mensaje}</p>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="consultarAPIDHL()" class="btn btn-secondary">Intentar de nuevo</button>
                        <a href="https://www.dhl.com/es-es/home/tracking.html" target="_blank" 
                           style="display: inline-block; padding: 10px 20px; background: #ff6b00; color: white; text-decoration: none; border-radius: 6px;">
                            Consultar en DHL.com
                        </a>
                    </div>
                </div>
            `;
        }

        function obtenerColorEstado(statusCode) {
            const colores = {
                'pickup': '#3b82f6',      // Azul
                'transit': '#f59e0b',     // Amarillo/Naranja
                'delivered': '#10b981',   // Verde
                'failure': '#dc2626',     // Rojo
                'unknown': '#6b7280'      // Gris
            };
            return colores[statusCode] || '#6b7280';
        }

        function obtenerIconoEstado(statusCode) {
            const iconos = {
                'pickup': 'üì¶',
                'transit': 'üöö',
                'delivered': '‚úÖ',
                'failure': '‚ö†Ô∏è',
                'unknown': '‚ùì'
            };
            return iconos[statusCode] || 'üìã';
        }

        function formatearFecha(fechaISO) {
            if (!fechaISO) return 'N/A';
            const fecha = new Date(fechaISO);
            return fecha.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatearFechaHora(fechaHoraISO) {
            if (!fechaHoraISO) return 'N/A';
            const fecha = new Date(fechaHoraISO);
            return fecha.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Funci√≥n para permitir Enter en el input de tracking
        document.addEventListener('DOMContentLoaded', function() {
            // Este listener se agregar√° cuando se cargue completamente la p√°gina
            setTimeout(() => {
                const trackingInput = document.getElementById('tracking-input');
                if (trackingInput) {
                    trackingInput.addEventListener('keypress', function(event) {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            consultarAPIDHL();
                        }
                    });
                }

                // Event listeners para DHL entries
                const entradaTracking = document.getElementById('entrada-tracking');
                const entradaAsunto = document.getElementById('entrada-asunto');
                
                if (entradaTracking) {
                    entradaTracking.addEventListener('keypress', function(event) {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            entradaAsunto.focus();
                        }
                    });
                }
                
                if (entradaAsunto) {
                    entradaAsunto.addEventListener('keypress', function(event) {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            guardarEntradaDHL();
                        }
                    });
                }
            }, 1000);
        });

        // ===============================
        // FUNCIONES PARA GESTI√ìN DE ENTRADAS DHL
        // ===============================

        // Variable global para almacenar entradas DHL
        let entradasDHL = JSON.parse(localStorage.getItem('entradasDHL')) || [];

        function guardarEntradaDHL() {
            const tracking = document.getElementById('entrada-tracking').value.trim();
            const asunto = document.getElementById('entrada-asunto').value.trim();

            if (!tracking) {
                alert('‚ùå Por favor, ingresa un n√∫mero de tracking.');
                return;
            }

            if (!asunto) {
                alert('‚ùå Por favor, ingresa un asunto.');
                return;
            }

            // Verificar si ya existe una entrada con el mismo tracking
            const yaExiste = entradasDHL.some(entrada => entrada.tracking === tracking);
            if (yaExiste) {
                alert('‚ö†Ô∏è Ya existe una entrada con este n√∫mero de tracking.');
                return;
            }

            // Crear nueva entrada
            const nuevaEntrada = {
                id: Date.now(),
                tracking: tracking,
                asunto: asunto,
                fecha_creacion: new Date().toLocaleDateString(),
                hora_creacion: new Date().toLocaleTimeString()
            };

            // Agregar a la lista
            entradasDHL.unshift(nuevaEntrada); // Agregar al inicio para mostrar las m√°s recientes primero
            
            // Guardar en localStorage
            localStorage.setItem('entradasDHL', JSON.stringify(entradasDHL));

            // Limpiar campos
            document.getElementById('entrada-tracking').value = '';
            document.getElementById('entrada-asunto').value = '';

            // Actualizar lista
            mostrarEntradasDHL();

            // Mensaje de √©xito
            alert('‚úÖ Entrada DHL guardada exitosamente.');
        }

        function mostrarEntradasDHL() {
            const container = document.getElementById('lista-entradas-dhl');
            
            if (entradasDHL.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #9ca3af;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üìã</div>
                        <p>No hay entradas guardadas</p>
                        <p style="font-size: 14px;">Usa el formulario de arriba para crear tu primera entrada</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = entradasDHL.map(entrada => `
                <div style="
                    display: flex; 
                    justify-content: space-between; 
                    align-items: center; 
                    padding: 15px; 
                    border: 1px solid #e5e7eb; 
                    border-radius: 8px; 
                    margin-bottom: 10px; 
                    background: white;
                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                ">
                    <div style="flex: 1;">
                        <div style="display: flex; gap: 20px; align-items: center;">
                            <div>
                                <strong style="color: #374151; font-size: 16px;">${entrada.tracking}</strong>
                                <div style="color: #6b7280; font-size: 12px; margin-top: 2px;">
                                    ${entrada.fecha_creacion} ‚Ä¢ ${entrada.hora_creacion}
                                </div>
                            </div>
                            <div style="flex: 1;">
                                <div style="color: #374151; font-size: 14px;">${entrada.asunto}</div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="consultarEntradaDHL('${entrada.tracking}')" 
                                style="
                                    background: #ff6b00; 
                                    color: white; 
                                    border: none; 
                                    padding: 8px 12px; 
                                    border-radius: 6px; 
                                    cursor: pointer; 
                                    font-size: 12px;
                                    font-weight: 500;
                                " 
                                title="Consultar seguimiento">
                            üîç Consultar
                        </button>
                        <button onclick="eliminarEntradaDHL(${entrada.id})" 
                                style="
                                    background: #dc2626; 
                                    color: white; 
                                    border: none; 
                                    padding: 8px 12px; 
                                    border-radius: 6px; 
                                    cursor: pointer; 
                                    font-size: 12px;
                                    font-weight: 500;
                                " 
                                title="Eliminar entrada">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function consultarEntradaDHL(tracking) {
            // Llenar el campo de tracking con el valor de la entrada
            document.getElementById('tracking-input').value = tracking;
            
            // Llamar a la funci√≥n de consulta
            consultarAPIDHL();
        }

        function eliminarEntradaDHL(entradaId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta entrada?')) {
                return;
            }

            // Filtrar para eliminar la entrada
            entradasDHL = entradasDHL.filter(entrada => entrada.id !== entradaId);
            
            // Guardar en localStorage
            localStorage.setItem('entradasDHL', JSON.stringify(entradasDHL));
            
            // Actualizar lista
            mostrarEntradasDHL();
        }

        function inicializarEntradasDHL() {
            mostrarEntradasDHL();
        }

        // Funciones para manejo de PDFs
        function getFileData(pedido, tipo) {
            // Devuelve la URL del archivo almacenado o un placeholder
            switch(tipo) {
                case 'oferta':
                    return pedido.oferta_pdf || '';
                case 'eproc':
                    return ''; // EPROC lanzado no tiene PDF, solo el firmado
                case 'po':
                    return (pedido.eproc_firmado && pedido.eproc_firmado.pdf_url) || '';
                case 'packing':
                    return (pedido.packing_list && pedido.packing_list.pdf_url) || '';
                case 'etiquetas':
                    return (pedido.etiquetas && pedido.etiquetas.pdf_url) || '';
                default:
                    return '';
            }
        }

        function abrirPDF(nombreArchivo, fileData, pedidoId, tipo) {
            if (fileData && fileData.startsWith('data:')) {
                try {
                    // Si es un archivo base64, crear un blob y abrirlo
                    const byteCharacters = atob(fileData.split(',')[1]);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], {type: 'application/pdf'});
                    const url = URL.createObjectURL(blob);
                    window.open(url, '_blank');
                    
                    // Limpiar la URL despu√©s de un tiempo
                    setTimeout(() => URL.revokeObjectURL(url), 10000);
                } catch (error) {
                    console.error('Error al abrir PDF:', error);
                    mostrarOpcionCargarPDF(nombreArchivo, pedidoId, tipo);
                }
            } else if (fileData && fileData.startsWith('http')) {
                // Si es una URL, abrirla directamente
                window.open(fileData, '_blank');
            } else {
                // Si no hay archivo, mostrar opci√≥n de carga
                mostrarOpcionCargarPDF(nombreArchivo, pedidoId, tipo);
            }
        }

        function mostrarOpcionCargarPDF(nombreArchivo, pedidoId, tipo) {
            const resultado = confirm(`üìÑ ${nombreArchivo}\n\n‚ùå Archivo no disponible o corrupto.\n\n¬øDeseas cargar este archivo ahora?`);
            
            if (resultado) {
                abrirSelectorArchivoPDF(pedidoId, tipo, nombreArchivo);
            }
        }

        function abrirSelectorArchivoPDF(pedidoId, tipo, nombreArchivo) {
            // Crear un input file temporal
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.pdf';
            input.style.display = 'none';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file && file.type === 'application/pdf') {
                    procesarYGuardarPDF(file, pedidoId, tipo, nombreArchivo);
                } else {
                    alert('‚ùå Por favor, selecciona un archivo PDF v√°lido.');
                }
            };
            
            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
        }

        async function procesarYGuardarPDF(file, pedidoId, tipo, nombreArchivo) {
            try {
                // Mostrar mensaje de procesamiento
                const originalAlert = alert;
                
                // Procesar archivo a Base64
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Data = e.target.result;
                    
                    // Buscar el pedido y actualizar el campo correspondiente
                    const pedido = pedidos.find(p => p.id === pedidoId);
                    if (!pedido) {
                        alert('‚ùå Error: No se encontr√≥ el pedido.');
                        return;
                    }
                    
                    // Guardar el PDF en el campo correspondiente
                    switch(tipo) {
                        case 'oferta':
                            pedido.oferta_pdf = base64Data;
                            break;
                        case 'po':
                            if (!pedido.eproc_firmado) pedido.eproc_firmado = {};
                            pedido.eproc_firmado.pdf_url = base64Data;
                            break;
                        case 'packing':
                            if (!pedido.packing_list) pedido.packing_list = {};
                            pedido.packing_list.pdf_url = base64Data;
                            break;
                        case 'etiquetas':
                            if (!pedido.etiquetas) pedido.etiquetas = {};
                            pedido.etiquetas.pdf_url = base64Data;
                            break;
                    }
                    
                    // Guardar cambios
                    guardarDatos();
                    
                    // Actualizar interfaz
                    mostrarPedidos();
                    
                    // Confirmar √©xito y abrir el PDF
                    alert(`‚úÖ ${nombreArchivo} cargado exitosamente.\n\nüìÑ El archivo se abrir√° autom√°ticamente.`);
                    
                    // Abrir el PDF reci√©n cargado
                    setTimeout(() => {
                        abrirPDF(nombreArchivo, base64Data, pedidoId, tipo);
                    }, 500);
                };
                
                reader.onerror = function() {
                    alert('‚ùå Error al leer el archivo. Int√©ntalo de nuevo.');
                };
                
                reader.readAsDataURL(file);
                
            } catch (error) {
                console.error('Error al procesar PDF:', error);
                alert('‚ùå Error al procesar el archivo PDF. Int√©ntalo de nuevo.');
            }
        }

        function procesarArchivoPDF(file) {
            return new Promise((resolve, reject) => {
                if (file && file.type === 'application/pdf') {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        resolve(e.target.result); // Devuelve base64
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                } else {
                    reject(new Error('Archivo no v√°lido'));
                }
            });
        }

        // Estados
        function avanzarEstado(pedidoId) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            const estadoIndex = ESTADOS.indexOf(pedido.estado);
                
            if (estadoIndex < ESTADOS.length - 1) {
                pedido.estado = ESTADOS[estadoIndex + 1];
                guardarDatos();
                mostrarPedidos();
            }
        }

        function retrocederEstado(pedidoId) {
            if (confirm('¬øEst√° seguro de que desea retroceder al estado anterior?')) {
                const pedido = pedidos.find(p => p.id === pedidoId);
                const estadoIndex = ESTADOS.indexOf(pedido.estado);
                
                if (estadoIndex > 0) {
                    pedido.estado = ESTADOS[estadoIndex - 1];
                    guardarDatos();
                    mostrarPedidos();
                }
            }
        }

        // Form handlers
        document.getElementById('form-crear-pedido').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const grid = document.getElementById('pieces-grid');
            const piezas = [];
            let total = 0;
            
            for (let i = 1; i < grid.children.length; i++) {
                const row = grid.children[i];
                const cantidad = parseInt(row.children[3].value);
                const precio = parseFloat(row.children[4].value);
                
                piezas.push({
                    referencia: row.children[0].value,
                    descripcion: row.children[1].value,
                    proyecto: row.children[2].value,
                    cantidad: cantidad,
                    precio_unitario: precio,
                    precio_total: cantidad * precio
                });
                
                total += cantidad * precio;
            }
            
            // Procesar el PDF de la oferta
            const file = formData.get('oferta_pdf');
            let pdfUrl = '';
            
            if (file && file.size > 0) {
                try {
                    pdfUrl = await procesarArchivoPDF(file);
                } catch (error) {
                    alert('Error al procesar el archivo PDF');
                    return;
                }
            }
            
            const nuevoPedido = {
                id: nextId++,
                numero_oferta: formData.get('numero_oferta'),
                proveedor: formData.get('proveedor'),
                email_proveedor: formData.get('email_proveedor'),
                fecha_oferta: formData.get('fecha_oferta'),
                fecha_creacion: new Date().toLocaleDateString(),
                estado: 'oferta_recibida',
                piezas: piezas,
                total: total,
                oferta_pdf: pdfUrl
            };
            
            pedidos.push(nuevoPedido);
            guardarDatos();
            mostrarPedidos();
            cerrarModal();
        });

        // Nuevos form handlers
        document.getElementById('form-lanzar-eproc').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const pedidoId = parseInt(document.getElementById('lanzar-eproc-pedido-id').value);
            const pedido = pedidos.find(p => p.id === pedidoId);
            
            if (pedido) {
                pedido.eproc = {
                    numero: formData.get('numero'),
                    oi: formData.get('oi'),
                    short_description: formData.get('short_description'),
                    fecha: formData.get('fecha')
                };
                pedido.estado = 'eproc_lanzado';
                
                guardarDatos();
                mostrarPedidos();
                cerrarModalLanzarEproc();
            }
        });

        document.getElementById('form-firmar-eproc').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const pedidoId = parseInt(document.getElementById('firmar-eproc-pedido-id').value);
            const pedido = pedidos.find(p => p.id === pedidoId);
            
            if (pedido) {
                const file = formData.get('pdf');
                let pdfUrl = '';
                
                if (file && file.size > 0) {
                    try {
                        pdfUrl = await procesarArchivoPDF(file);
                    } catch (error) {
                        alert('Error al procesar el archivo PDF');
                        return;
                    }
                }
                
                pedido.eproc_firmado = {
                    pdf: file ? file.name : 'PO_signed.pdf',
                    pdf_url: pdfUrl,
                    po: formData.get('po'),
                    fecha: formData.get('fecha')
                };
                pedido.estado = 'eproc_firmado';
                
                guardarDatos();
                mostrarPedidos();
                cerrarModalFirmarEproc();
            }
        });

        document.getElementById('form-packing-list').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const pedidoId = parseInt(document.getElementById('packing-list-pedido-id').value);
            const pedido = pedidos.find(p => p.id === pedidoId);
            
            if (pedido) {
                const file = formData.get('pdf');
                let pdfUrl = '';
                
                if (file && file.size > 0) {
                    try {
                        pdfUrl = await procesarArchivoPDF(file);
                    } catch (error) {
                        alert('Error al procesar el archivo PDF');
                        return;
                    }
                }
                
                const numBultos = parseInt(formData.get('bultos'));
                
                // Usar la configuraci√≥n de bultos global si existe
                let configuracionBultos = {};
                let infoBultos = {};
                
                if (window.configuracionBultos) {
                    configuracionBultos = window.configuracionBultos;
                    infoBultos = window.infoBultos || {};
                } else {
                    // Fallback: crear configuraci√≥n vac√≠a
                    for (let i = 1; i <= numBultos; i++) {
                        configuracionBultos[`bulto_${i}`] = [];
                        infoBultos[`bulto_${i}`] = { peso: 0, dimensiones: '' };
                    }
                }
                
                pedido.packing_list = {
                    pdf: file ? file.name : 'packinglist.pdf',
                    pdf_url: pdfUrl,
                    bultos: numBultos,
                    fecha: formData.get('fecha'),
                    peso_total: parseFloat(formData.get('peso_total')) || 0
                };
                
                // Guardar configuraci√≥n de bultos e informaci√≥n adicional
                pedido.configuracion_bultos = configuracionBultos;
                pedido.info_bultos = infoBultos;
                pedido.estado = 'packing_list_creado';
                
                guardarDatos();
                mostrarPedidos();
                cerrarModalPackingList();
                
                // Limpiar variables globales
                window.configuracionBultos = null;
                window.piezasDisponibles = null;
                window.infoBultos = null;
            }
        });

        document.getElementById('form-lanzar-tar').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const pedidoId = parseInt(document.getElementById('lanzar-tar-pedido-id').value);
            const pedido = pedidos.find(p => p.id === pedidoId);
            
            if (pedido) {
                pedido.tar = {
                    numero: formData.get('numero'),
                    email: formData.get('email'),
                    url: formData.get('url'),
                    fecha: formData.get('fecha')
                };
                pedido.estado = 'tar_lanzado';
                
                guardarDatos();
                mostrarPedidos();
                cerrarModalLanzarTar();
            }
        });

        document.getElementById('form-enviar-etiquetas').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const pedidoId = parseInt(document.getElementById('enviar-etiquetas-pedido-id').value);
            const pedido = pedidos.find(p => p.id === pedidoId);
            
            if (pedido) {
                const file = formData.get('pdf');
                let pdfUrl = '';
                
                if (file && file.size > 0) {
                    try {
                        pdfUrl = await procesarArchivoPDF(file);
                    } catch (error) {
                        alert('Error al procesar el archivo PDF');
                        return;
                    }
                }
                
                const trackingNumber = formData.get('tracking');
                const fechaEnvio = formData.get('fecha');
                const direccionRecogida = formData.get('direccion_envio'); // Renombrado para mayor claridad
                
                // Guardar datos del pedido
                pedido.etiquetas = {
                    pdf: file ? file.name : 'etiquetas.pdf',
                    pdf_url: pdfUrl,
                    tracking: trackingNumber,
                    fecha: fechaEnvio,
                    direccion_recogida: direccionRecogida // Nombre correcto
                };
                pedido.estado = 'etiquetas_enviadas';
                
                // Ya no generamos email autom√°ticamente aqu√≠,
                // ahora se hace con el bot√≥n verde espec√≠fico
                
                guardarDatos();
                mostrarPedidos();
                cerrarModalEnviarEtiquetas();
            }
        });

        // Form handler para crear TAR
        document.getElementById('form-crear-tar').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const grid = document.getElementById('tar-pieces-grid');
            const piezas = [];
            let total = 0;
            
            for (let i = 1; i < grid.children.length; i++) {
                const row = grid.children[i];
                const cantidad = parseInt(row.children[3].value);
                const precio = parseFloat(row.children[4].value);
                
                piezas.push({
                    referencia: row.children[0].value,
                    descripcion: row.children[1].value,
                    proyecto: row.children[2].value,
                    cantidad: cantidad,
                    precio_unitario: precio,
                    precio_total: cantidad * precio
                });
                
                total += cantidad * precio;
            }
            
            // Procesar el PDF de la oferta
            const file = formData.get('oferta_pdf');
            let pdfUrl = '';
            
            if (file && file.size > 0) {
                try {
                    pdfUrl = await procesarArchivoPDF(file);
                } catch (error) {
                    alert('Error al procesar el archivo PDF');
                    return;
                }
            }
            
            const nuevoTar = {
                id: nextId++,
                numero_oferta: formData.get('numero_oferta'),
                proveedor: formData.get('proveedor'),
                email_proveedor: formData.get('email_proveedor'),
                fecha_oferta: formData.get('fecha_oferta'),
                fecha_creacion: new Date().toLocaleDateString(),
                estado: 'eproc_firmado', // TAR empieza en eproc_firmado (saltando oferta_recibida y eproc_lanzado)
                piezas: piezas,
                total: total,
                oferta_pdf: pdfUrl,
                tipo: 'TAR', // Identificador para distinguir TARs de pedidos normales
                // Datos predefinidos de EPROC (porque el TAR ya tiene esta info)
                eproc: {
                    numero: formData.get('numero_eproc'),
                    oi: formData.get('oi_eproc'),
                    fecha: new Date().toLocaleDateString()
                }
            };
            
            pedidos.push(nuevoTar);
            guardarDatos();
            mostrarPedidos();
            cerrarModalCrearTar();
        });

        

       

        // ===============================
        // FUNCI√ìN PARA EMAIL DE ETIQUETAS
        // ===============================

        function generarEmailEtiquetas(pedido, trackingNumber, fechaEnvio) {
            try {
                // Obtener informaci√≥n del proveedor
                const proveedor = pedido.proveedor || 'Proveedor';
                const emailProveedor = pedido.email_proveedor || '';
                
                // Obtener informaci√≥n del PO desde eproc_firmado
                const numeroPO = pedido.eproc_firmado?.po || 'Not available';
                
                // Informaci√≥n de los bultos - usar configuraci√≥n de packing list
                let infoBultos = '';
                if (pedido.configuracion_bultos && pedido.info_bultos) {
                    infoBultos = generarInfoBultosDetallada(pedido.configuracion_bultos, pedido.info_bultos);
                } else if (pedido.packing_list && pedido.packing_list.bultos > 1) {
                    infoBultos = `PACKAGE DISTRIBUTION:\n- ${pedido.packing_list.bultos} packages total\n`;
                } else {
                    infoBultos = 'PACKAGE DISTRIBUTION:\n- 1 package containing all items\n';
                }
                
                // Actualizar direcciones seg√∫n especificaciones
                const direccionRecogida = pedido.etiquetas?.direccion_recogida || 'No especificada'; // Direcci√≥n de recogida desde el modal (sin defecto)
                const direccionEntrega = 'C/ Linares Pol Ca√±ada Fuente15\n23600 MARTOS\nSpain'; // Direcci√≥n fija de entrega correcta
                
                // Crear asunto del email
                const asunto = `Shipping Labels Ready - PO: ${numeroPO} - Offer #${pedido.numero_oferta || 'N/A'} - Tracking: ${trackingNumber || 'TBD'}`;

                // Crear cuerpo del email con el formato solicitado
                const cuerpoEmail = `Hello,

Labels for shipping are ready.

ORDER DETAILS:
Offer #: ${pedido.numero_oferta || 'N/A'}
PO: ${numeroPO}
Tracking Number: ${trackingNumber || 'To be provided by courier'}

${infoBultos}
SHIPPING INFORMATION:
Pickup: ${direccionRecogida}
Delivery: ${direccionEntrega}

Best regards,
Logistics Team`.trim();

                // Crear URL para Gmail
                const gmailBaseUrl = 'https://mail.google.com/mail/?view=cm&fs=1';
                const emailParams = new URLSearchParams({
                    to: emailProveedor,
                    su: asunto,
                    body: cuerpoEmail
                });
                
                const gmailUrl = `${gmailBaseUrl}&${emailParams.toString()}`;
                
                // Abrir Gmail en nueva pesta√±a
                window.open(gmailUrl, '_blank');
                
                console.log('üìß Email generado para etiquetas:', {
                    pedido: pedido.id,
                    tracking: trackingNumber,
                    proveedor: proveedor,
                    asunto: asunto,
                    po: numeroPO
                });
                
            } catch (error) {
                console.error('Error al generar email de etiquetas:', error);
                alert('‚ùå Error al generar el email autom√°tico.\n\nPuedes crear el email manualmente con la informaci√≥n del pedido.');
            }
        }
        
        function generarInfoBultosDetallada(configuracionBultos, infoBultos) {
            if (!configuracionBultos || Object.keys(configuracionBultos).length === 0) {
                return 'PACKAGE DISTRIBUTION:\n- 1 package containing all items\n';
            }
            
            let info = 'PACKAGE DISTRIBUTION:\n';
            
            Object.keys(configuracionBultos).forEach((bultoClave, index) => {
                const numeroBulto = index + 1;
                const piezasEnBulto = configuracionBultos[bultoClave];
                const infoBulto = infoBultos[bultoClave] || {};
                
                info += `\nPackage ${numeroBulto}:\n`;
                
                if (infoBulto.peso) {
                    info += `‚Ä¢ Weight: ${infoBulto.peso} kg\n`;
                }
                if (infoBulto.dimensiones) {
                    info += `‚Ä¢ Dimensions: ${infoBulto.dimensiones}\n`;
                }
                
                if (piezasEnBulto && piezasEnBulto.length > 0) {
                    info += `‚Ä¢ Contents:\n`;
                    piezasEnBulto.forEach(pieza => {
                        info += `  - ${pieza.referencia} x${pieza.cantidad}\n`;
                    });
                }
            });
            
            return info;
        }

        function generarInfoBultos(bultos) {
            if (!bultos || bultos.length === 0) {
                return 'PACKAGE DISTRIBUTION:\n- 1 standard package\n';
            }
            
            let info = 'PACKAGE DISTRIBUTION:\n';
            bultos.forEach((bulto, index) => {
                info += `\nPackage ${index + 1}:\n`;
                info += `‚Ä¢ Weight: ${bulto.peso || 'Not specified'} kg\n`;
                info += `‚Ä¢ Dimensions: ${bulto.dimensiones || 'Not specified'}\n`;
                
                if (bulto.piezas && bulto.piezas.length > 0) {
                    info += `‚Ä¢ Contents:\n`;
                    bulto.piezas.forEach(pieza => {
                        info += `  - ${pieza.referencia} (${pieza.cantidad_en_bulto} units)\n`;
                    });
                }
            });
            
            return info;
        }

        
    </script>
</body>
</html>
